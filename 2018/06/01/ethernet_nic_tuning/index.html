<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="slot status12345$ 05:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)$ lspci -s 05:00.0 -vvv | grep -Ei &#39;8G|MSI-X&#39;      Capabilities: [70] MSI-X: Enable+">
<meta property="og:type" content="article">
<meta property="og:title" content="ethernet nic tuning">
<meta property="og:url" content="http://yoursite.com/2018/06/01/ethernet_nic_tuning/index.html">
<meta property="og:site_name" content="b946c5a0bf547c89">
<meta property="og:description" content="slot status12345$ 05:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)$ lspci -s 05:00.0 -vvv | grep -Ei &#39;8G|MSI-X&#39;      Capabilities: [70] MSI-X: Enable+">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-06-01T02:49:42.000Z">
<meta property="article:modified_time" content="2020-01-08T15:23:20.822Z">
<meta property="article:author" content="Ginger">
<meta property="article:tag" content="benchmark">
<meta property="article:tag" content="nic">
<meta property="article:tag" content="irq">
<meta property="article:tag" content="network">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2018/06/01/ethernet_nic_tuning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>ethernet nic tuning | b946c5a0bf547c89</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">b946c5a0bf547c89</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Silent Hill</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/01/ethernet_nic_tuning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ethernet nic tuning
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-01 10:49:42" itemprop="dateCreated datePublished" datetime="2018-06-01T10:49:42+08:00">2018-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-08 23:23:20" itemprop="dateModified" datetime="2020-01-08T23:23:20+08:00">2020-01-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/06/01/ethernet_nic_tuning/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/06/01/ethernet_nic_tuning/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>22 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="slot-status"><a href="#slot-status" class="headerlink" title="slot status"></a>slot status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ 05:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 <span class="keyword">for</span> 25GbE SFP28 (rev 02)</span><br><span class="line">$ lspci -s 05:00.0 -vvv | grep -Ei <span class="string">'8G|MSI-X'</span></span><br><span class="line">      Capabilities: [70] MSI-X: Enable+ Count=129 Masked-</span><br><span class="line">              LnkCap: Port <span class="comment">#0, Speed 8GT/s, Width x8, ASPM L1, Latency L0 &lt;2us, L1 &lt;16us</span></span><br><span class="line">              LnkSta: Speed 8GT/s, Width x8, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="Tune-adm-policy"><a href="#Tune-adm-policy" class="headerlink" title="Tune-adm policy"></a>Tune-adm policy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># default config files</span><br><span class="line">$ ls &#x2F;usr&#x2F;lib&#x2F;tuned</span><br><span class="line">balanced  desktop  functions  latency-performance  network-latency  network-throughput  powersave  recommend.d  throughput-performance  virtual-guest  virtual-host</span><br><span class="line"></span><br><span class="line">$ tuned-adm list</span><br><span class="line">$ tuned-adm profile network-throughput</span><br><span class="line">$ tuned-adm active</span><br></pre></td></tr></table></figure>

<p>Custom tuned.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ &#x2F;etc&#x2F;tuned&#x2F;my-variables.conf</span><br><span class="line"></span><br><span class="line">[variables]</span><br><span class="line">include&#x3D;&#x2F;etc&#x2F;tuned&#x2F;my-variables.conf</span><br><span class="line"></span><br><span class="line">[bootloader]</span><br><span class="line">cmdline&#x3D;isolcpus&#x3D;0,1,2,3</span><br></pre></td></tr></table></figure>

<h3 id="CPU-setting"><a href="#CPU-setting" class="headerlink" title="CPU setting"></a>CPU setting</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cpupower  frequency-set -g performance</span><br><span class="line">cpupower idle-set -d 3</span><br><span class="line">cpupower idle-set -d 2</span><br><span class="line">cpupower idle-set -d 1</span><br><span class="line">cpupower idle-set -d 0</span><br></pre></td></tr></table></figure>

<h3 id="nic-offload"><a href="#nic-offload" class="headerlink" title="nic offload"></a>nic offload</h3><table>
<thead>
<tr>
<th>Features</th>
<th>status</th>
</tr>
</thead>
<tbody><tr>
<td>TSO TCP Segmentation Offload</td>
<td>hardware on</td>
</tr>
<tr>
<td>GSO Generic Segmentation Offload,soft TSO</td>
<td>software off</td>
</tr>
<tr>
<td>GRO Generic Receive Offload</td>
<td>hardware on</td>
</tr>
<tr>
<td>UFO UDP Fragmentation Offload</td>
<td>hardware off fixed</td>
</tr>
<tr>
<td>rx-checksumming</td>
<td>hardware on</td>
</tr>
<tr>
<td>tx-checksumming</td>
<td>hardware on</td>
</tr>
<tr>
<td>scatter-gather</td>
<td>hardware on</td>
</tr>
<tr>
<td>RSS Receive side scaling</td>
<td>hardware on</td>
</tr>
<tr>
<td>RPS software RSS</td>
<td>software off</td>
</tr>
<tr>
<td>RFS Receive Flow Streering,UDP support ?</td>
<td>software on</td>
</tr>
<tr>
<td>XPS Transmit Packet Steering</td>
<td>software on</td>
</tr>
<tr>
<td>busy-poll: on fixed</td>
<td>hw and sw, work with sysctl.net.core.busy_poll &gt; 0</td>
</tr>
</tbody></table>
<p>TSO = LSO (also called large segmentation offload)<br>RFS and XPS has the same function from receive or transmit, avoid cache miss, numa overhead<br>Receive Packet Steering (RPS) is logically a software implementation of RSS<br>Generic segmentation offload (GSO) is logically a software implementation of TSO</p>
<p>if TSO was on, disable GSO, same with RSS and RPS</p>
<p>Enabling the RFS requires enabling the ‘ntuple’ flag via the ethtool,RFS requires the kernel to be compiled with the CONFIG_RFS_ACCEL option. This options is available in kernels 2.6.39 and above. Furthermore, RFS requires Device Managed Flow Steering support.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --offload enp5s0 rx on tx on</span><br><span class="line">Actual changes:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable TSO</span></span><br><span class="line"><span class="comment"># If your NIC not support TSO, you could enable GSO</span></span><br><span class="line">$ ethtool -K enp4s0 tso on</span><br><span class="line">$ ethtool -K enp4s0 gso off</span><br></pre></td></tr></table></figure>

<h4 id="Resize-the-hardware-buffer-queue-to-max"><a href="#Resize-the-hardware-buffer-queue-to-max" class="headerlink" title="Resize the hardware buffer queue to max"></a>Resize the hardware buffer queue to max</h4><p>Reduce the number of packets being dropped by increasing the size of the queue so that the it does not overflow as easily</p>
<p>big buffer will cause high latency with the throughput setting</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G enp1s0f0 RX 4096 TX 4096</span><br><span class="line">$ ethtool -g enp1s0f0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br></pre></td></tr></table></figure>

<h3 id="Interrupt-Queues"><a href="#Interrupt-Queues" class="headerlink" title="Interrupt Queues"></a>Interrupt Queues</h3><h4 id="Busy-Polling"><a href="#Busy-Polling" class="headerlink" title="Busy Polling"></a>Busy Polling</h4><p>Busy polling helps reduce latency in the network receive path by allowing socket layer code to poll the receive queue of a network device, and disabling network interrupts. </p>
<p><code>This removes delays caused by the interrupt and the resultant context switch.</code><br>However, <code>it also increases CPU utilization</code>. Busy polling also prevents the CPU from sleeping, which can incur additional power consumption.</p>
<p>single queue map single cpu core, avoid lock or race cpu resource </p>
<p>kernel 3.11 support SO_BUSY_POLL<br>Busy polling is disabled by default (sysctl.net.core.busy_poll = 0)<br>This parameter controls the number of microseconds to wait for packets on the device queue for socket poll and selects. Red Hat recommends a value of 50</p>
<p>To enable busy polling globally<br>you must also set sysctl.net.core.busy_read to a value other than 0.<br>This parameter controls the number of microseconds to wait for packets on the device queue for socket reads.<br>It also sets the default value of the SO_BUSY_POLL option. </p>
<p>Red Hat recommends a value of 50 for a small number of sockets, and a value of 100 for large numbers of sockets. For extremely large numbers of sockets (more than several hundred), use epoll(kernel 4.12) instead.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sw</span></span><br><span class="line">net.core.busy_poll = 50 <span class="comment"># default 0</span></span><br><span class="line">net.core.busy_read = 100 <span class="comment"># default 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hw</span></span><br><span class="line">$ ethtool -k device | grep <span class="string">"busy-poll"</span></span><br><span class="line">busy-poll: on [fixed]</span><br></pre></td></tr></table></figure>

<p>Busy polling behavior is supported by the following drivers. These drivers are also supported on Red Hat Enterprise Linux 7.1<br>driver support: bnx2x,be2net,ixgbe,mlx4,myri10ge</p>
<p>mlx4 driver with busy polling</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rx-usecs: 16</span><br><span class="line">rx-frames: 44</span><br></pre></td></tr></table></figure>
<p><a href="http://www.cnhalo.net/2017/07/24/linux-busy-poll/" target="_blank" rel="noopener">netperf TCP_RR 1 byte payload each way, 3.11 kernel,default 17500tps, busy poll could reach 6300tps</a></p>
<h3 id="Socket-receive-queues"><a href="#Socket-receive-queues" class="headerlink" title="Socket receive queues"></a>Socket receive queues</h3><h4 id="Change-the-speed-of-the-incoming-queue"><a href="#Change-the-speed-of-the-incoming-queue" class="headerlink" title="Change the speed of the incoming queue"></a>Change the speed of the incoming queue</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/net/core/dev_weight</span><br><span class="line">64</span><br><span class="line"><span class="comment">#64 was default value</span></span><br></pre></td></tr></table></figure>

<p>The maximum number of packets that kernel can handle on a NAPI interrupt, it’s a Per-CPU variable. For drivers that support LRO or GRO_HW, a hardware aggregated packet is counted as one packet in this context.</p>
<p>Device weight refers to the number of packets a device can receive at one time (in a single scheduled processor access). You can increase the rate at which a queue is drained by increasing its device weight, which is controlled by the dev_weight parameter.</p>
<p>it will increase CPU overhead</p>
<p>Altering the drain rate of a queue is usually the simplest way to mitigate poor network performance. However, increasing the number of packets that a device can receive at one time uses additional processor time, during which no other processes can be scheduled, so this can cause other performance problems.</p>
<h5 id="Increase-the-depth-of-the-application’s-socket-queue"><a href="#Increase-the-depth-of-the-application’s-socket-queue" class="headerlink" title="Increase the depth of the application’s socket queue"></a>Increase the depth of the application’s socket queue</h5><p>Increase the value of /proc/sys/net/core/rmem_default</p>
<p>This parameter controls the default size of the receive buffer used by sockets. This value must be smaller than or equal to the value of /proc/sys/net/core/rmem_max.</p>
<h4 id="Use-setsockopt-to-configure-a-larger-SO-RCVBUF-value-userspace"><a href="#Use-setsockopt-to-configure-a-larger-SO-RCVBUF-value-userspace" class="headerlink" title="Use setsockopt to configure a larger SO_RCVBUF value (userspace)"></a>Use setsockopt to configure a larger SO_RCVBUF value (userspace)</h4><p>This parameter controls the maximum size in bytes of a socket’s receive buffer. Use the getsockopt system call to determine the current value of the buffer.</p>
<h4 id="RSS-IRQ-Affinity"><a href="#RSS-IRQ-Affinity" class="headerlink" title="RSS IRQ Affinity"></a><a href="https://access.redhat.com/solutions/2144921" target="_blank" rel="noopener">RSS IRQ Affinity</a></h4><table>
<thead>
<tr>
<th>CPU</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>0001</td>
<td>0010</td>
<td>0100</td>
<td>1000</td>
<td>10000</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Deci</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>8</td>
<td>16</td>
<td>32</td>
<td>64</td>
<td>128</td>
<td>256</td>
<td>512</td>
<td>1024</td>
<td>2048</td>
<td>4096</td>
</tr>
<tr>
<td>Hex</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>8</td>
<td>10</td>
<td>20</td>
<td>40</td>
<td>80</td>
<td>100</td>
<td>200</td>
<td>400</td>
<td>800</td>
<td>1000</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555 <span class="comment">#numa_node0</span></span><br><span class="line"></span><br><span class="line">$ awk -F: <span class="string">'$0~/enp5/ || $0~/mlx4/ &#123;print $1&#125;'</span> /proc/interrupts | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 555 &gt; /proc/irq/<span class="variable">$line</span>/smp_affinity</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#For example, to handle interrupts with CPUs 0, 1, 2, and 3, set the value of rps_cpus to f, which is the hexadecimal value for 15. In binary representation, 15 is 00001111 (1+2+4+8).</span></span><br><span class="line"></span><br><span class="line">or you could</span><br><span class="line">/sys/class/net</span><br><span class="line">eno1 -&gt; ../../devices/pci0000:17/0000:17:02.0/0000:18:00.0/net/eno1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0</span><br><span class="line">$ ls /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0/msi_irqs</span><br><span class="line">56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85</span><br><span class="line">$ ls -l /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0/msi_irqs</span><br><span class="line"></span><br><span class="line"><span class="comment">#intel</span></span><br><span class="line">$ set_irq_affinity -x all ethX</span><br><span class="line">$ set_irq_affinity -x <span class="built_in">local</span> ethX</span><br><span class="line">$ set_irq_affinity 1-2 ethX</span><br><span class="line"></span><br><span class="line"><span class="comment">#mellanox</span></span><br><span class="line">set_irq_affinity_bynode.sh 0 p7p1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">printf</span> %0.2x<span class="string">'\n'</span> 1024</span><br><span class="line">400</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">printf</span> %0.2x<span class="string">'\n'</span> 4096</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 400 &gt; /proc/irq/66/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 400 &gt; /proc/irq/67/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /proc/irq/69/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /proc/irq/70/smp_affinity</span><br></pre></td></tr></table></figure>
<p>When configuring RSS, Red Hat recommends <code>limiting the number of queues to one per physical CPU core</code><br>Hyper-threads are often represented as separate cores in analysis tools, but configuring queues for all cores including logical cores such as <code>hyper-threads has not proven beneficial to network performance</code></p>
<p>When enabled, RSS distributes network processing equally between available CPUs based on the amount of processing each CPU has queued. However, you can use the ethtool –show-rxfh-indir and –set-rxfh-indir parameters to modify how network activity is distributed, and weight certain types of network activity as more important than others.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --<span class="built_in">set</span>-rxfh-indir enp1s0f0 equal 4</span><br><span class="line">$ watch -d  -n 1 <span class="string">"cat /proc/interrupts | grep enp1s0f0"</span></span><br><span class="line"><span class="comment"># You could see only 4 interrupt number increase a lot</span></span><br><span class="line"></span><br><span class="line">$ ethtool --show-rxfh-indir enp1s0f0</span><br><span class="line">RX flow <span class="built_in">hash</span> indirection table <span class="keyword">for</span> enp1s0f0 with 12 RX ring(s):</span><br><span class="line">    0:      0     1     2     3     0     1     2     3</span><br><span class="line">    8:      0     1     2     3     0     1     2     3</span><br><span class="line">   16:      0     1     2     3     0     1     2     3</span><br><span class="line">   24:      0     1     2     3     0     1     2     3</span><br><span class="line">   32:      0     1     2     3     0     1     2     3</span><br><span class="line">   40:      0     1     2     3     0     1     2     3</span><br><span class="line">   48:      0     1     2     3     0     1     2     3</span><br><span class="line">   56:      0     1     2     3     0     1     2     3</span><br><span class="line">   64:      0     1     2     3     0     1     2     3</span><br><span class="line">   72:      0     1     2     3     0     1     2     3</span><br><span class="line">   80:      0     1     2     3     0     1     2     3</span><br><span class="line">   88:      0     1     2     3     0     1     2     3</span><br><span class="line">   96:      0     1     2     3     0     1     2     3</span><br><span class="line">  104:      0     1     2     3     0     1     2     3</span><br><span class="line">  112:      0     1     2     3     0     1     2     3</span><br><span class="line">  120:      0     1     2     3     0     1     2     3</span><br><span class="line">RSS <span class="built_in">hash</span> key:</span><br><span class="line">04:86:d4:1c:b4:14:3d:48:7b:48:29:2d:cc:c1:2c:67:eb:66:b0:c9:98:89:30:24:cb:ff:59:2a:54:13:5a:d6:1d:70:71:09:a4:fa:fd:89</span><br><span class="line">RSS <span class="built_in">hash</span> <span class="keyword">function</span>:</span><br><span class="line">    toeplitz: on</span><br><span class="line">    xor: off</span><br><span class="line">    crc32: off</span><br><span class="line"></span><br><span class="line"><span class="comment"># set weight for the queue</span></span><br><span class="line">$ ethtool --<span class="built_in">set</span>-rxfh-indir eth3 weight 6 2</span><br><span class="line">$ ethtool --<span class="built_in">set</span>-rxfh-indir eth3 weight 1 2</span><br></pre></td></tr></table></figure>

<p><code>The irqbalance daemon can be used in conjunction with RSS to reduce the likelihood of cross-node memory transfers and cache line bouncing. This lowers the latency of processing network packets.</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> irqbalance</span><br><span class="line">$ systemctl start irqbalance</span><br></pre></td></tr></table></figure>


<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index" target="_blank" rel="noopener">redhat performance tuning guide</a><br><a href="https://fasterdata.es.net/host-tuning/100g-tuning/" target="_blank" rel="noopener">100GbE tuning</a><br><a href="https://www.intel.com/content/dam/www/public/us/en/documents/reference-guides/xl710-x710-performance-tuning-linux-guide.pdf" target="_blank" rel="noopener">xl710-x710-performance-tuning-linux-guide</a></p>
<h3 id="Receive-Flow-Streering-RFS"><a href="#Receive-Flow-Streering-RFS" class="headerlink" title="Receive Flow Streering (RFS)"></a>Receive Flow Streering (RFS)</h3><p>RFS is disabled by default. To enable RFS, you must edit two files:<br>/proc/sys/net/core/rps_sock_flow_entries</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 32768 &gt; /proc/sys/net/core/rps_sock_flow_entries</span><br><span class="line">$ <span class="keyword">for</span> f <span class="keyword">in</span> /sys/class/net/ens6/queues/rx-*/rps_flow_cnt; <span class="keyword">do</span> <span class="built_in">echo</span> 4096 &gt; <span class="variable">$f</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>Set the value of this file to the maximum expected number of concurrently active connections. We recommend a value of 32768 for moderate server loads. All values entered are rounded up to the nearest power of 2 in practice.</p>
<p>Set the value of this file to the value of rps_sock_flow_entries divided by N, where N is the number of receive queues on a device. For example, if rps_flow_entries is set to 32768 and there are 16 configured receive queues, rps_flow_cnt should be set to 2048(I improve it to 4096). For single-queue devices, the value of rps_flow_cnt is the same as the value of rps_sock_flow_entries.</p>
<p>Data received from a single sender is not sent to more than one CPU. If the amount of data received from a single sender is greater than a single CPU can handle, configure a larger frame size to reduce the number of interrupts and therefore the amount of processing work for the CPU.</p>
<p>About large frame </p>
<ul>
<li>large mtu</li>
<li>TCP Segmentation Offload, merge to large than mtu size</li>
</ul>
<p>Consider using numactl or taskset in conjunction with RFS to pin applications to specific cores, sockets, or NUMA nodes. This can help prevent packets from being processed out of order.</p>
<h5 id="Accelerated-RFS"><a href="#Accelerated-RFS" class="headerlink" title="Accelerated RFS"></a>Accelerated RFS</h5><p>RFS and accelerated RFS (aRFS) are kernel features currently available in most distributions. The aRFS feature requires explicit configuration in order to enable it.<br>it need the driver support</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_RFS_ACCEL=y</span><br><span class="line">CONFIG_MLX5_EN_ARFS=y</span><br></pre></td></tr></table></figure>

<p>Accelerated RFS boosts the speed of RFS by adding hardware assistance. Like RFS, packets are forwarded based on the location of the application consuming the packet. Unlike traditional RFS, however, packets are sent directly to a CPU that is local to the thread consuming the data: either the CPU that is executing the application, or a CPU local to that CPU in the cache hierarchy.<br>Accelerated RFS is only available if the following conditions are met:<br>Accelerated RFS must be supported by the network interface card. Accelerated RFS is supported by cards that export the ndo_rx_flow_steer() netdevice function.<br>ntuple filtering must be enabled.</p>
<p>CPU to queue mapping is deduced based on the IRQ affinities configured by the driver for each receive queue.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -K ens6 ntuple on</span><br><span class="line">$ ethtool -k ens6</span><br><span class="line">ntuple-filters: on</span><br><span class="line">$ systemctl stop irqbalance</span><br><span class="line"><span class="comment">#Configure your IRQ settings to ensure each RX queue is handled by one of your desired network processing CPUs.</span></span><br><span class="line"><span class="comment"># if you are mellanox NIC</span></span><br><span class="line"></span><br><span class="line">$ show_irq_affinity.sh ens6</span><br></pre></td></tr></table></figure>

<p><a href="https://community.mellanox.com/s/article/howto-configure-arfs-on-connectx-4" target="_blank" rel="noopener">monitor</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S eno1 | egrep rx.*pack</span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">$ ethtool -K ens6 ntuple off</span><br><span class="line"></span><br><span class="line">$ taskset -c 5 netserver &amp;</span><br><span class="line">$ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM &amp;</span><br><span class="line"></span><br><span class="line">$ ethtool -S ens6 | egrep rx.*pack</span><br><span class="line"><span class="comment"># only rx8 improved</span></span><br><span class="line">rx7_packets: 0</span><br><span class="line">rx7_lro_packets: 0</span><br><span class="line">rx8_packets: 6296748</span><br><span class="line">rx8_lro_packets: 0</span><br><span class="line">rx9_packets: 0</span><br><span class="line"></span><br><span class="line">$ ethtool -K ens6 ntuple on</span><br><span class="line">$ taskset -c 5 netserver &amp;</span><br><span class="line">$ netperf -H 11.134.201.5 -l 200 -t TCP_STREAM &amp;</span><br><span class="line">$ ethtool -S ens6 | egrep rx.*pack</span><br><span class="line">rx5_packets: 234532 <span class="comment"># only rx5 increase, it ‘s worked</span></span><br><span class="line">rx5_lro_packets: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># mellanox enable the driver arfs</span></span><br><span class="line">$ enable_arfs.sh ens6</span><br></pre></td></tr></table></figure>

<h3 id="Interrupt-Moderation-interrupt-coalescence-or-Interrupt-Blanking"><a href="#Interrupt-Moderation-interrupt-coalescence-or-Interrupt-Blanking" class="headerlink" title="Interrupt Moderation (interrupt coalescence or Interrupt Blanking)"></a>Interrupt Moderation (interrupt coalescence or Interrupt Blanking)</h3><p>parm:           InterruptThrottleRate:Maximum interrupts per second, per vector, (0,1,956-488281), default 1 (array of int) </p>
<p>0 = Setting InterruptThrottleRate to 0 turns off any interrupt moderation and may improve small packet latency, but is generally not suitable for bulk throughput traffic due to the increased cpu utilization of the higher interrupt rate. Please note that on 82599-based adapters, disabling InterruptThrottleRate will also result in the driver disabling HW RSC(receive side coalescing).</p>
<p>HW RSC looks like TCP Segmentation offload or GSO, merge 1500~9000 mtu to a large frame(65536 or more), you could get it by tcpdump</p>
<p>On 82598-based adapters, disabling InterruptThrottleRate will also result in disabling LRO (Large Receive Offloads).</p>
<p>1 = Dynamic mode attempts to moderate interrupts per vector while maintaining very low latency. <code>This can sometimes cause extra CPU utilization.</code><br>If planning on deploying ixgbe in a latency sensitive environment please consider this parameter.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe ixgbe InterruptThrottleRate&#x3D;8000,4000</span><br></pre></td></tr></table></figure>
<p>956-488281, Interrupt Throttle Rate (interrupts/sec). The ITR parameter controls how many interrupts each interrupt vector can generate per second. On MQ/RSS enabled kernels with MSI-X interrupts this means that each RX vector can generate 8000 interrupts per second and each TX vector can generate 4000 interrupts per second. Increasing ITR lowers latency at the cost of increased CPU utilization, though it may help throughput in some circumstances.</p>
<p><code>Note: Adaptive moderation must be disabled in order to ensure that static values are in use.</code><br>It is possible to change the values for ethtool as well:</p>
<p>Mellanox example</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C eth4 rx-usecs 0 rx-frames 10 tx-usecs 16 tx-frames 100</span><br></pre></td></tr></table></figure>
<p>if you need to improve value of rx-usecs, improve latency and througput, and suggestion improve </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#must tso could be enabled</span><br><span class="line">$ ethtool -K eth2 tso on </span><br><span class="line">$ net.ipv4.tcp_tso_win_divisor &#x3D; 30 #default 3</span><br></pre></td></tr></table></figure>
<p>This allows control over what percentage of the congestion window can be consumed by a single TSO frame. The setting of this parameter is a choice between burstiness and building larger TSO frames.</p>
<p>rx-frames[-irq] rx-usecs[-irq] tx-frames[-irq] tx-usecs[-irq]<br>The range of 0-235 microseconds provides an effective range of 4,310 to 250,000 interrupts per second. The value of rx-µsecs-high can be set independent of rx-µsecs and tx-µsecs in the same ethtool command, and is also independent of the adaptive interrupt moderation algorithm. The underlying hardware supports granularity in 2-microsecond intervals, so adjacent values might result in the same interrupt rate.</p>
<p>DIM is enabled by default. In case you wish to disable it .<br><a href="https://community.mellanox.com/s/article/dynamically-tuned-interrupt-moderation--dim-x" target="_blank" rel="noopener">not recommended disable Dynamically Interrupt Moderation</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#To turn on adaptive interrupt moderation, recommand</span></span><br><span class="line">$ ethtool -C ethX adaptive-rx on adaptive-tx on</span><br><span class="line"></span><br><span class="line"><span class="comment">#To turn off adaptive interrupt moderation</span></span><br><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off</span><br></pre></td></tr></table></figure>

<p>A good place to start for general tuning is 84 µs, or ~12000 interrupts/s. If you see rx_dropped counters are running during traffic (using ethtool -S ethX) then you probably have too slow of a CPU, not enough buffers from the adapter’s ring size (ethtool -G) to hold packets for 84 µs or to low of an interrupt rate.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 84 tx-usecs 84</span><br></pre></td></tr></table></figure>

<p>The next value to try, if you are not maxed out on CPU utilization, is 62 µs. This uses more CPU, but it services buffers faster, and requires fewer descriptors (ring size, ethtool -G). </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 62 tx-usecs 62</span><br></pre></td></tr></table></figure>
<p>If your CPU is at 100%, then increasing the interrupt rate is not advised. In certain circumstances such as a CPU bound workload, you might want to increase the µs value to enable more CPU time for other applications.</p>
<p>If you require low latency performance and/or have plenty of CPU to devote to network processing, you can disable interrupt moderation entirely, which enables the interrupts to fire as fast as possible.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 0 tx-usecs 0</span><br></pre></td></tr></table></figure>
<p>Totaly, tx,rx-usecs value the lower means the smaller frame to interrupt moderation. the more cpu overhead and the lower latency<br>increase tx,tx-usecs that means high latency and get the biger frame to interrupt moderation, the lower cpu overhead and high latency and high througput, it will impact tcp performance, so increase tcp_tso_win_divisor to 30</p>
<p>If cache pressure is suspected (many queues active) reducing buffers from default can help Intel® Data Direct I/O (Intel® DDIO) operate with better efficiently. Intel recommends trying 128 or 256 per queue, being aware that an increase in interrupt rate via ethtool -C might be necessary to avoid an increase in rx_dropped.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G eth12 rx 256 tx 256</span><br></pre></td></tr></table></figure>

<p>Change the Tx and Rx ring sizes as needed, a larger value takes more resources but can provide better forwarding rates:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G ethX rx 4096 tx 4096</span><br></pre></td></tr></table></figure>

<p>Layer 2 flow control can impact TCP performance considerably and is recommended to be disabled for most workloads</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -A ethX rx off tx off</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -c enp4s0d1</span><br><span class="line">Coalesce parameters <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">Adaptive RX: off  TX: off</span><br><span class="line">stats-block-usecs: 0</span><br><span class="line">sample-interval: 0</span><br><span class="line">pkt-rate-low: 400000</span><br><span class="line">pkt-rate-high: 450000</span><br><span class="line"></span><br><span class="line">rx-usecs: 0</span><br><span class="line">rx-frames: 0</span><br><span class="line">rx-usecs-irq: 0</span><br><span class="line">rx-frames-irq: 0</span><br><span class="line"></span><br><span class="line">tx-usecs: 8</span><br><span class="line">tx-frames: 16</span><br><span class="line">tx-usecs-irq: 0</span><br><span class="line">tx-frames-irq: 256</span><br><span class="line"></span><br><span class="line">rx-usecs-low: 0</span><br><span class="line">rx-frame-low: 0</span><br><span class="line">tx-usecs-low: 0</span><br><span class="line">tx-frame-low: 0</span><br><span class="line"></span><br><span class="line">rx-usecs-high: 128</span><br><span class="line">rx-frame-high: 0</span><br><span class="line">tx-usecs-high: 0</span><br><span class="line">tx-frame-high: 0</span><br><span class="line"></span><br><span class="line">$ ethtool -i p5p2</span><br><span class="line">driver: i40e</span><br><span class="line">version: 2.4.6</span><br><span class="line">firmware-version: 6.01 0x80003554 1.1747.0</span><br><span class="line">bus-info: 0000:05:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line">$ ethtool -l p5p2</span><br><span class="line">Channel parameters <span class="keyword">for</span> p5p2:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:             0</span><br><span class="line">TX:             0</span><br><span class="line">Other:          1</span><br><span class="line">Combined:       64</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:             0</span><br><span class="line">TX:             0</span><br><span class="line">Other:          1</span><br><span class="line">Combined:       8</span><br><span class="line"></span><br><span class="line">$ ethtool -g p5p2</span><br><span class="line">Ring parameters <span class="keyword">for</span> p5p2:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:             4096</span><br><span class="line">RX Mini:        0</span><br><span class="line">RX Jumbo:       0</span><br><span class="line">TX:             4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:             512</span><br><span class="line">RX Mini:        0</span><br><span class="line">RX Jumbo:       0</span><br><span class="line">TX:             512</span><br></pre></td></tr></table></figure>

<p><a href="https://download.01.org/packet-processing/ONPS2.1/Intel_ONP_Release_2.1_Performance_Test_Report_Rev1.0.pdf" target="_blank" rel="noopener">Intel_ONP_Release_2.1_performance_test_report</a></p>
<h3 id="disable-PCIE-power-save"><a href="#disable-PCIE-power-save" class="headerlink" title="disable PCIE power save"></a>disable PCIE power save</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">'pcie_aspm=off'</span> --args=<span class="string">'intel_idle.max_cstate=0'</span> --args=<span class="string">'processor.max_cstate=1'</span></span><br></pre></td></tr></table></figure>

<h3 id="The-old-sysctl-conf"><a href="#The-old-sysctl-conf" class="headerlink" title="The old sysctl.conf"></a>The old sysctl.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">net.core.netdev_max_backlog = 300000</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.core.netdev_budget=600</span><br><span class="line">net.ipv4.tcp_timestamps=1</span><br><span class="line">net.ipv4.tcp_low_latency=1</span><br><span class="line"><span class="comment"># allow auto-tuning up to 128MB buffers</span></span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 134217728</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 134217728</span><br><span class="line"><span class="comment">### 256M</span></span><br><span class="line">net.core.rmem_max = 268435456 <span class="comment">#Socket Receive Queues, avoid package loss</span></span><br><span class="line">net.core.wmem_max = 268435456</span><br><span class="line">net.core.somaxconn=16384</span><br><span class="line">net.ipv4.tcp_tw_reuse=1</span><br><span class="line">net.ipv4.tcp_adv_win_scale=1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_mtu_probing=1</span><br><span class="line">net.core.rmem_max=16777216</span><br><span class="line"><span class="comment">#net.core.default_qdisc = pfifo_fast</span></span><br><span class="line">net.ipv4.tcp_congestion_control=cubic</span><br><span class="line"><span class="comment"># net.ipv4.tcp_frto=1</span></span><br><span class="line"><span class="comment"># works best with &lt;= 500 client computers ##</span></span><br><span class="line">net.ipv4.neigh.default.gc_interval = 3600</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 3600</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3 = 8192</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2 = 4096</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1 = 2048</span><br><span class="line"><span class="comment"># don't cache ssthresh from previous connection</span></span><br><span class="line">net.ipv4.tcp_no_metrics_save = 1</span><br><span class="line">net.ipv4.tcp_mtu_probing=1</span><br></pre></td></tr></table></figure>

<h4 id="disable-numa"><a href="#disable-numa" class="headerlink" title="disable numa"></a>disable numa</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo kernel.numa_balancing&#x3D;0 &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="RFC2544-stipulates-that-the-latency-test"><a href="#RFC2544-stipulates-that-the-latency-test" class="headerlink" title="RFC2544 stipulates that the latency test"></a>RFC2544 stipulates that the latency test</h3><ul>
<li>Should be at least 120 seconds in duration</li>
<li>Frame sizes to be used on Ethernet 64, 128, 256, 512, 1024, 1280, and 1518</li>
<li>Should include an identifying tag in one frame after 60 seconds with the type of tag being implementation dependent</li>
<li>Records the time at which the frame is fully transmitted (timestamp A)</li>
<li>The receiver logic in the test equipment must recognize the tag information in the frame stream and record the time at which the tagged frame was received (timestamp B)</li>
<li>This test should be performed with the test frame addressed to the same destination as the rest of the data stream, and also with each of the test frames addressed to a new destination network</li>
<li>The test must be repeated at least 20 times with the reported value being the average of the recorded values</li>
<li>The latency is timestamp B minus timestamp A, as per the relevant definition from RFC</li>
</ul>
<h3 id="The-network-latency"><a href="#The-network-latency" class="headerlink" title="The network latency"></a><a href="https://www.marvell.com/documents/rjx203ukari4r93gntem/" target="_blank" rel="noopener">The network latency</a></h3><p>There are new technologies that are pushing latencies into the singledigit microsecond range when measured back-to-back in benchmark<br>repeat 20 times and get the average result</p>
<p>50 – 125μs   1Gb Ethernet (TCP/IP)</p>
<ul>
<li>Multi-tasking: multiple highbandwidth applications running<br>simultaneously</li>
<li>Bulk data transfer</li>
<li>Transactional database backup and<br>applications</li>
<li>Web (front-end for data centers)</li>
</ul>
<p>5 – 50μs 10Gb Ethernet<br>(TCP/IP)</p>
<ul>
<li>Bulk data transfer</li>
<li>Real-time video streaming</li>
<li>Database backup and applications</li>
</ul>
<p>3 – 5μs RDMA, RoCEE, and<br>iWARP</p>
<ul>
<li>High Performance Computing</li>
<li>High-Frequency Trading (HFT)</li>
<li>Inter-process communication (IPC)<br>cluster</li>
<li>Low-latency applications</li>
</ul>
<p>Sub-3μs(less than 3μs) InfiniBand (QDR)<br>and proprietary</p>
<ul>
<li>High Performance Computing</li>
<li>High Frequency Trading (HFT)</li>
<li>Ultra-low latency applications</li>
</ul>
<h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><h4 id="nc-test"><a href="#nc-test" class="headerlink" title="nc test"></a>nc test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Server $ nc -l 22222 &lt; /dev/zero</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 &gt; /dev/null</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 | pv  <span class="comment"># show the speed</span></span><br></pre></td></tr></table></figure>

<h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ iperf3 -s -D -p 520<span class="variable">$i</span></span><br><span class="line">Client $ iperf3 -c <span class="variable">$client_ip</span> -P 1 -t 360000 -p 520<span class="variable">$i</span></span><br></pre></td></tr></table></figure>

<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server $ qperf -lp <span class="variable">$port</span> &amp;</span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 36000 -oo msg_size:1K:4K:*2 <span class="variable">$server_ip</span> tcp_bw </span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 60 -oo msg_size:64:1024K:*4 <span class="variable">$server_ip</span> tcp_lat</span><br></pre></td></tr></table></figure>

<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ taskset -c 5 netserver &amp;</span><br><span class="line">Client $ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM</span><br></pre></td></tr></table></figure>

<h4 id="irqbalance"><a href="#irqbalance" class="headerlink" title="irqbalance"></a>irqbalance</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--powerthresh </span><br><span class="line">--hintpolicy </span><br><span class="line">--policyscript </span><br><span class="line">--banirq</span><br><span class="line">--ban </span><br><span class="line">--balance_level </span><br><span class="line">--numa_node</span><br></pre></td></tr></table></figure>

<h4 id="turbostat"><a href="#turbostat" class="headerlink" title="turbostat"></a>turbostat</h4><h4 id="numastat"><a href="#numastat" class="headerlink" title="numastat"></a>numastat</h4><h4 id="numad"><a href="#numad" class="headerlink" title="numad"></a>numad</h4><h4 id="OProfile"><a href="#OProfile" class="headerlink" title="OProfile"></a>OProfile</h4><h4 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool&#x3D;memcheck --leak-check&#x3D;yes --show-reachable&#x3D;yes --num-callers&#x3D;20 --track-fds&#x3D;yes .&#x2F;lustre_exporter</span><br></pre></td></tr></table></figure>

<h4 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ yum install intel-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME 2020-01-07 17:54:05</span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy </span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth                             </span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB&#x2F;s]   MBR[MB&#x2F;s]</span><br><span class="line">                                            </span><br><span class="line">       0  0.26       6k      1080.0         0.2         0.0</span><br><span class="line">       1  0.26       0k         0.0         0.0         0.0</span><br><span class="line">       2  0.27       4k      4600.0         0.5         0.0</span><br><span class="line">       3  0.26       5k       520.0         0.0         0.2</span><br><span class="line">       4  0.27       8k      1120.0         0.7         0.1</span><br><span class="line">       5  0.25      12k      1080.0         0.7         0.2</span><br><span class="line">       6  0.28      18k      1040.0         0.9         0.1</span><br><span class="line">       7  0.25       0k         0.0         0.0         0.0</span><br><span class="line">       8  0.27       4k      3400.0         0.2         0.1</span><br><span class="line">       9  0.25       0k      1360.0         0.1         0.1</span><br><span class="line">      10  0.26      14k      7000.0         1.3         0.0</span><br><span class="line">      11  0.39       1k       120.0         0.0         0.0</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples" target="_blank" rel="noopener">Usage-example</a></p>
<p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p>
<h3 id="mellanox-nic-exapmle"><a href="#mellanox-nic-exapmle" class="headerlink" title="mellanox nic exapmle"></a>mellanox nic exapmle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -k  enp131s0f1</span><br><span class="line">Features for enp131s0f1:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ip-generic: off [fixed]</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">	tx-checksum-fcoe-crc: off [fixed]</span><br><span class="line">	tx-checksum-sctp: off [fixed]</span><br><span class="line">scatter-gather: on</span><br><span class="line">	tx-scatter-gather: on</span><br><span class="line">	tx-scatter-gather-fraglist: off [fixed]</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp-ecn-segmentation: off [fixed]</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line">	tx-tcp-mangleid-segmentation: off</span><br><span class="line">udp-fragmentation-offload: off [fixed]</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">large-receive-offload: on</span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: off</span><br><span class="line">receive-hashing: on</span><br><span class="line">highdma: on [fixed]</span><br><span class="line">rx-vlan-filter: on</span><br><span class="line">vlan-challenged: off [fixed]</span><br><span class="line">tx-lockless: off [fixed]</span><br><span class="line">netns-local: off [fixed]</span><br><span class="line">tx-gso-robust: off [fixed]</span><br><span class="line">tx-fcoe-segmentation: off [fixed]</span><br><span class="line">tx-gre-segmentation: on</span><br><span class="line">tx-ipip-segmentation: off [fixed]</span><br><span class="line">tx-sit-segmentation: off [fixed]</span><br><span class="line">tx-udp_tnl-segmentation: on</span><br><span class="line">fcoe-mtu: off [fixed]</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off [fixed]</span><br><span class="line">rx-fcs: off</span><br><span class="line">rx-all: off</span><br><span class="line">tx-vlan-stag-hw-insert: on</span><br><span class="line">rx-vlan-stag-hw-parse: off [fixed]</span><br><span class="line">rx-vlan-stag-filter: on [fixed]</span><br><span class="line">busy-poll: off [fixed]</span><br><span class="line">tx-gre-csum-segmentation: on</span><br><span class="line">tx-udp_tnl-csum-segmentation: on</span><br><span class="line">tx-gso-partial: on</span><br><span class="line">tx-sctp-segmentation: off [fixed]</span><br><span class="line">rx-gro-hw: off [fixed]</span><br><span class="line">l2-fwd-offload: off [fixed]</span><br><span class="line">hw-tc-offload: off</span><br><span class="line">rx-udp_tunnel-port-offload: on</span><br><span class="line">[root@cngb-oss-a23-1 ~]# ethtool -i enp131s0f1</span><br><span class="line">driver: mlx5_core</span><br><span class="line">version: 5.0-0</span><br><span class="line">firmware-version: 14.20.1010 (MT_2420110034)</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:83:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line">ethtool -g enp131s0f1</span><br><span class="line">Ring parameters for enp131s0f1:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		8192</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		8192</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		8192</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		8192</span><br><span class="line"></span><br><span class="line">ethtool -i enp131s0f1</span><br><span class="line">driver: mlx5_core</span><br><span class="line">version: 5.0-0</span><br><span class="line">firmware-version: 14.20.1010 (MT_2420110034)</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:83:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure>

<h3 id="ixgbe-example"><a href="#ixgbe-example" class="headerlink" title="ixgbe example"></a>ixgbe example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -g enp1s0f0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line"></span><br><span class="line">$ ethtool -i enp1s0f0</span><br><span class="line">driver: ixgbe</span><br><span class="line">version: 5.5.2</span><br><span class="line">firmware-version: 0x800006da, 255.65535.255</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:01:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Features <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: off [fixed]</span><br><span class="line">	tx-checksum-ip-generic: on</span><br><span class="line">	tx-checksum-ipv6: off [fixed]</span><br><span class="line">	tx-checksum-fcoe-crc: on [fixed]</span><br><span class="line">	tx-checksum-sctp: on</span><br><span class="line">scatter-gather: on</span><br><span class="line">	tx-scatter-gather: on</span><br><span class="line">	tx-scatter-gather-fraglist: off [fixed]</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp-ecn-segmentation: off [fixed]</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line">	tx-tcp-mangleid-segmentation: off</span><br><span class="line">udp-fragmentation-offload: off [fixed]</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">large-receive-offload: off    </span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: off</span><br><span class="line">receive-hashing: on</span><br><span class="line">highdma: on [fixed]</span><br><span class="line">rx-vlan-filter: on</span><br><span class="line">vlan-challenged: off [fixed]</span><br><span class="line">tx-lockless: off [fixed]</span><br><span class="line">netns-local: off [fixed]</span><br><span class="line">tx-gso-robust: off [fixed]</span><br><span class="line">tx-fcoe-segmentation: on [fixed]</span><br><span class="line">tx-gre-segmentation: on</span><br><span class="line">tx-ipip-segmentation: off [fixed]</span><br><span class="line">tx-sit-segmentation: off [fixed]</span><br><span class="line">tx-udp_tnl-segmentation: on</span><br><span class="line">fcoe-mtu: off [fixed]</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off [fixed]</span><br><span class="line">rx-fcs: off [fixed]</span><br><span class="line">rx-all: off</span><br><span class="line">tx-vlan-stag-hw-insert: off [fixed]</span><br><span class="line">rx-vlan-stag-hw-parse: off [fixed]</span><br><span class="line">rx-vlan-stag-filter: off [fixed]</span><br><span class="line">busy-poll: on [fixed]</span><br><span class="line">tx-gre-csum-segmentation: on</span><br><span class="line">tx-udp_tnl-csum-segmentation: on</span><br><span class="line">tx-gso-partial: on</span><br><span class="line">tx-sctp-segmentation: off [fixed]</span><br><span class="line">rx-gro-hw: off [fixed]</span><br><span class="line">l2-fwd-offload: off [fixed]</span><br><span class="line">hw-tc-offload: off</span><br><span class="line">rx-udp_tunnel-port-offload: on</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/benchmark/" rel="tag"><i class="fa fa-tag"></i> benchmark</a>
              <a href="/tags/nic/" rel="tag"><i class="fa fa-tag"></i> nic</a>
              <a href="/tags/irq/" rel="tag"><i class="fa fa-tag"></i> irq</a>
              <a href="/tags/network/" rel="tag"><i class="fa fa-tag"></i> network</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/05/27/ipmi/" rel="prev" title="ipmitool">
      <i class="fa fa-chevron-left"></i> ipmitool
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/06/01/tcp/" rel="next" title="Network setting">
      Network setting <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#slot-status"><span class="nav-number">1.</span> <span class="nav-text">slot status</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tune-adm-policy"><span class="nav-number">2.</span> <span class="nav-text">Tune-adm policy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-setting"><span class="nav-number">3.</span> <span class="nav-text">CPU setting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nic-offload"><span class="nav-number">4.</span> <span class="nav-text">nic offload</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Resize-the-hardware-buffer-queue-to-max"><span class="nav-number">4.1.</span> <span class="nav-text">Resize the hardware buffer queue to max</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interrupt-Queues"><span class="nav-number">5.</span> <span class="nav-text">Interrupt Queues</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Busy-Polling"><span class="nav-number">5.1.</span> <span class="nav-text">Busy Polling</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Socket-receive-queues"><span class="nav-number">6.</span> <span class="nav-text">Socket receive queues</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Change-the-speed-of-the-incoming-queue"><span class="nav-number">6.1.</span> <span class="nav-text">Change the speed of the incoming queue</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Increase-the-depth-of-the-application’s-socket-queue"><span class="nav-number">6.1.1.</span> <span class="nav-text">Increase the depth of the application’s socket queue</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Use-setsockopt-to-configure-a-larger-SO-RCVBUF-value-userspace"><span class="nav-number">6.2.</span> <span class="nav-text">Use setsockopt to configure a larger SO_RCVBUF value (userspace)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RSS-IRQ-Affinity"><span class="nav-number">6.3.</span> <span class="nav-text">RSS IRQ Affinity</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Receive-Flow-Streering-RFS"><span class="nav-number">7.</span> <span class="nav-text">Receive Flow Streering (RFS)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Accelerated-RFS"><span class="nav-number">7.0.1.</span> <span class="nav-text">Accelerated RFS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interrupt-Moderation-interrupt-coalescence-or-Interrupt-Blanking"><span class="nav-number">8.</span> <span class="nav-text">Interrupt Moderation (interrupt coalescence or Interrupt Blanking)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#disable-PCIE-power-save"><span class="nav-number">9.</span> <span class="nav-text">disable PCIE power save</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-old-sysctl-conf"><span class="nav-number">10.</span> <span class="nav-text">The old sysctl.conf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#disable-numa"><span class="nav-number">10.1.</span> <span class="nav-text">disable numa</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RFC2544-stipulates-that-the-latency-test"><span class="nav-number">11.</span> <span class="nav-text">RFC2544 stipulates that the latency test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-network-latency"><span class="nav-number">12.</span> <span class="nav-text">The network latency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tools"><span class="nav-number">13.</span> <span class="nav-text">Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nc-test"><span class="nav-number">13.1.</span> <span class="nav-text">nc test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iperf3"><span class="nav-number">13.2.</span> <span class="nav-text">iperf3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#qperf"><span class="nav-number">13.3.</span> <span class="nav-text">qperf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#netperf"><span class="nav-number">13.4.</span> <span class="nav-text">netperf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#irqbalance"><span class="nav-number">13.5.</span> <span class="nav-text">irqbalance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#turbostat"><span class="nav-number">13.6.</span> <span class="nav-text">turbostat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#numastat"><span class="nav-number">13.7.</span> <span class="nav-text">numastat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#numad"><span class="nav-number">13.8.</span> <span class="nav-text">numad</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OProfile"><span class="nav-number">13.9.</span> <span class="nav-text">OProfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#valgrind"><span class="nav-number">13.10.</span> <span class="nav-text">valgrind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#intel-cmt-cat"><span class="nav-number">13.11.</span> <span class="nav-text">intel-cmt-cat</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mellanox-nic-exapmle"><span class="nav-number">14.</span> <span class="nav-text">mellanox nic exapmle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ixgbe-example"><span class="nav-number">15.</span> <span class="nav-text">ixgbe example</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ginger"
      src="/img/logo-4-blog.png">
  <p class="site-author-name" itemprop="name">Ginger</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ginger</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">737k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">11:10</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://b946c5a0bf547c89.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "http://yoursite.com/2018/06/01/ethernet_nic_tuning/",
            identifier: "2018/06/01/ethernet_nic_tuning/",
            title: "ethernet nic tuning"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://b946c5a0bf547c89.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
