<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="b946c5a0bf547c89">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="b946c5a0bf547c89">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ginger">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>b946c5a0bf547c89</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">b946c5a0bf547c89</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Silent Hill</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/01/mdadm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/01/mdadm/" class="post-title-link" itemprop="url">backup the mdraid info</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-06-01 12:40:20 / Modified: 14:12:18" itemprop="dateCreated datePublished" datetime="2020-06-01T12:40:20+08:00">2020-06-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mdraid/" itemprop="url" rel="index">
                    <span itemprop="name">mdraid</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/06/01/mdadm/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/01/mdadm/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="How-to-backup-mdraid-info-by-dd"><a href="#How-to-backup-mdraid-info-by-dd" class="headerlink" title="How to backup mdraid info by dd"></a><a href="https://raid.wiki.kernel.org/index.php/RAID_superblock_formats" target="_blank" rel="noopener">How to backup mdraid info by dd</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">md8 : active raid1 sde1[1] sda1[0]</span><br><span class="line">      468717568 blocks super 1.2 [2/2] [UU]</span><br><span class="line">      bitmap: 0/4 pages [0KB], 65536KB chunk</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sda1 of=./sda1 bs=1M count=1</span><br><span class="line"></span><br><span class="line">$ hexdump -C sda1 | head -n 20</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">Per-Array Identification &amp; Configuration area:16 Bytes</span><br><span class="line">                                                  0xc~0xf: padding block 0 </span><br><span class="line">00001000  <span class="built_in">fc</span> 4e 2b a9 01 00 00 00      01 00 00 00 00 00 00 00  |.N+.............|</span><br><span class="line">Magic num: a92b4efc Major version:1    0x8~0xb bit fearure_map:value 1 offset 0  raid map is used</span><br><span class="line">                                                   value 2 offset 1  raid recovery is progress</span><br><span class="line">                                                   value 4 offset 2 raid reshape is <span class="keyword">in</span> progress</span><br><span class="line">                                                   the others: undefined/reserved</span><br><span class="line"></span><br><span class="line">section: Per-Array Identification &amp; Configuration area 84 Bytes  </span><br><span class="line">          &lt;----------------------uuid--------------------&gt; 0x10-0x1f 16</span><br><span class="line">00001010  cb df 6a 02 54 1a 01 76  9b 9c 29 fe ab 08 8c a0  |..j.T..v..).....|</span><br><span class="line">/dev/sda1: UUID=<span class="string">"cbdf6a02-541a-0176-9b9c-29feab088ca0"</span></span><br><span class="line"></span><br><span class="line">&lt;--------------------------name <span class="keyword">for</span> the array------------&gt; 0x20-0x3f 32</span><br><span class="line">00001020  74 65 73 74 2d 74 65 73  74 2d 61 31 31 2d 32 2e  |<span class="built_in">test</span>-test-a11-2.|</span><br><span class="line">00001030  74 65 73 74 2e 73 7a 2e  68 70 63 3a 38 00 00 00  |test.sz.hpc:8...|</span><br><span class="line"></span><br><span class="line">ctime(lower 40bit are secs,high 24 bits are microsecs)</span><br><span class="line">                    |               raid1       0 means left asymmetric</span><br><span class="line">                    |                 |            |</span><br><span class="line">00001040  10 77 cc 5e 00 00 00 00  01 00 00 00 00 00 00 00  |.w.^............|a</span><br><span class="line"></span><br><span class="line">         size of component devices(<span class="keyword">in</span> <span class="comment"># of 512-byte sectors),echo $((16#37e02000))=937435136</span></span><br><span class="line">                     |             chucksize not used <span class="keyword">in</span> raid1,linear,multipath</span><br><span class="line">                     |                  |        raid disk(02 means low bit, only 2 x devs to mirror)</span><br><span class="line">00001050  00 20 e0 37 00 00 00 00  00 00 00 00 02 00 00 00  |. .7............|</span><br><span class="line"></span><br><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |     </span><br><span class="line">00001060  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: RAID-Reshape In-Process Metadata Storage/Recovery area 28 Bytes</span><br><span class="line">         he new RAID level being reshaped-to</span><br><span class="line">                           |       Next address of the array to reshape</span><br><span class="line">                                              |</span><br><span class="line">00001060              00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">     	change <span class="keyword">in</span> <span class="comment"># of raid disks</span></span><br><span class="line">               |   new layout <span class="keyword">for</span> array</span><br><span class="line">               |           |      New chunk size; padding block</span><br><span class="line">               |           |            |           |</span><br><span class="line">00001070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Section: This-Component-Device Information area 64Bytes</span><br><span class="line"> the sector <span class="comment"># upon which data starts, sectors in the device that are used for data</span></span><br><span class="line">                     |                        |</span><br><span class="line">00001080  00 08 04 00 00 00 00 00  00 20 e0 37 00 00 00 00  |......... .7....|</span><br><span class="line">of the sector upon <span class="built_in">which</span> this superblock starts</span><br><span class="line">                     |              sectors before this offset (from data_offset) have been recovered</span><br><span class="line">00001090  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">           dev_number</span><br><span class="line">               |      Number of <span class="built_in">read</span>-errors that were corrected by re-writing</span><br><span class="line">               |           |                uuid</span><br><span class="line">000010a0  00 00 00 00 00 00 00 00  07 a8 e4 bf b5 6f c7 d6  |.............o..|</span><br><span class="line">                   uuid           devflags  Padding block 2(1 bit)</span><br><span class="line">                    |              |  Padding block 2 (7 bit)</span><br><span class="line">000010b0  90 d1 9b 62 bf 89 <span class="built_in">cd</span> e7  00 00 08 00 10 00 00 00  |...b............|</span><br><span class="line"></span><br><span class="line">Section: Array-State Information area 64Btes</span><br><span class="line">Time of last superblock update    Event Count <span class="keyword">for</span> the Array</span><br><span class="line">                     |                        |</span><br><span class="line">000010c0  5a 73 d4 5e 00 00 00 00  e6 05 00 00 00 00 00 00  |Zs.^............|</span><br><span class="line"></span><br><span class="line">      Event Count <span class="keyword">for</span> the Array    sb_csum        max_dev 0x80=128</span><br><span class="line">                     |                  |           |</span><br><span class="line">000010d0  ff ff ff ff ff ff ff ff  cf 29 76 cf 80 00 00 00  |.........)v.....|</span><br><span class="line"></span><br><span class="line">&lt;----32Bytes------------zero---------padding-------------&gt;</span><br><span class="line">000010e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">000010f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: Device-Roles (Positions-in-Array) area</span><br><span class="line">Length: Variable number of bytes (but at least 768 bytes?)</span><br><span class="line">2 Bytes per device <span class="keyword">in</span> the array, including both spare-devices and faulty-devices</span><br><span class="line">*</span><br><span class="line">00001100  00 00 01 00 ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">00001110  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |</span><br><span class="line">00001060  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br></pre></td></tr></table></figure>

<p>In mdraid superblock, you could see bitmap starts at 8 x 512B=4096<br>You could see “bitm” magic num start at 0x1000=4096</p>
<p>You could see the data update from 0x1200, so you could backup first 4608 Bytes in raid1<br>dd if=/dev/sdb1 of=sdb1_superblock bs=1 count=4608</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00001000  fc 4e 2b a9 01 00 00 00  01 00 00 00 00 00 00 00  |.N+.............|</span><br><span class="line">00001010  a3 00 8f 75 49 1d ee e6  38 e6 cb d0 e5 3b 8b d2  |...uI...8....;..|</span><br><span class="line">00001020  74 65 73 74 2d 74 65 73  74 2d 61 31 31 2d 32 2e  |test-test-a11-2.|</span><br><span class="line">00001030  74 65 73 74 2e 73 7a 2e  68 70 63 3a 30 00 00 00  |test.sz.hpc:0...|</span><br><span class="line">00001040  16 71 cc 5e 00 00 00 00  01 00 00 00 00 00 00 00  |.q.^............|</span><br><span class="line">00001050  00 00 49 ba 00 00 00 00  00 00 00 00 02 00 00 00  |..I.............|</span><br><span class="line">00001060  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00001070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00001080  00 08 04 00 00 00 00 00  00 00 49 ba 00 00 00 00  |..........I.....|</span><br><span class="line">00001090  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">000010a0  00 00 00 00 00 00 00 00  d5 31 5f 6a c9 58 c2 a0  |.........1_j.X..|</span><br><span class="line">000010b0  55 50 81 dc 35 4b d1 e3  00 00 08 00 10 00 00 00  |UP..5K..........|</span><br><span class="line">000010c0  5a 99 d4 5e 00 00 00 00  0b 0d 00 00 00 00 00 00  |Z..^............|</span><br><span class="line">000010d0  ff ff ff ff ff ff ff ff  b5 64 59 a7 80 00 00 00  |.........dY.....|</span><br><span class="line">000010e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00001100  00 00 01 00 ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">00001110  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">00001200  e8 0f a4 c4 ee 8d 1a 13  fd 81 a0 d0 6b ef c3 10  |............k...|</span><br><span class="line">00001210  3f 90 15 39 9d 95 0d 1d  07 32 03 df 28 16 cc 06  |?..9.....2..(...|</span><br><span class="line">00001220  40 e6 dc 82 43 13 36 1e  c8 9c 3b fd f9 00 e5 15  |@...C.6...;.....|</span><br><span class="line">00001230  99 73 43 71 81 a1 b7 19  73 ee 5b 74 8e 3b 65 09  |.sCq....s.[t.;e.|</span><br><span class="line">00001240  ce fd 51 d7 43 6d ca 07  b9 3f 03 7c ff 61 79 1f  |..Q.Cm...?.|.ay.|</span><br><span class="line">00001250  f7 e7 a3 4f 3e 6e be 16  fe fc f8 d5              |...O&gt;n......|</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/system_tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/24/system_tools/" class="post-title-link" itemprop="url">System tools</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-24 16:29:06" itemprop="dateCreated datePublished" datetime="2020-03-24T16:29:06+08:00">2020-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-27 22:28:27" itemprop="dateModified" datetime="2020-03-27T22:28:27+08:00">2020-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index">
                    <span itemprop="name">tools</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/24/system_tools/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/24/system_tools/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="FIO-write"><a href="#FIO-write" class="headerlink" title="FIO write"></a>FIO write</h3><p>if not support fallocate, fio will switch to fadvise64 to write file<br>looks like fadvise64 cause a lot of file system fragment.</p>
<h3 id="10-billion-or-more-files-in-the-posix-filesystem-directory"><a href="#10-billion-or-more-files-in-the-posix-filesystem-directory" class="headerlink" title="10 billion or more files in the posix filesystem directory"></a>10 billion or more files in the posix filesystem directory</h3><p>ls take a long time, maybe three days or more<br>I moidfy form some C demo files just list some files, the program will exit , not full list</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ./walk /tank/<span class="built_in">test</span>/dir1 1000 | wc -l</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">real    0m0.016s</span><br><span class="line">user    0m0.000s</span><br><span class="line">sys     0m0.016s</span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ls /tank/<span class="built_in">test</span>/dir1/ | wc -l</span><br><span class="line">858601</span><br><span class="line"></span><br><span class="line">real    0m3.320s</span><br><span class="line">user    0m2.841s</span><br><span class="line">sys     0m0.476s</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *fullpath;</span><br><span class="line"><span class="keyword">int</span> global_count=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readfile</span><span class="params">(<span class="keyword">char</span> *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//printf ("print global_count value: %d\n",global_count);</span></span><br><span class="line">    DIR * dp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">dirrp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    p = fullpath + <span class="built_in">strlen</span>(fullpath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == lstat(fullpath,&amp;buf))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s[lstat]%s\n"</span>,fullpath,strerror(errno));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"file: %s \n"</span>,k); <span class="comment">// output file name</span></span><br><span class="line">        global_count--;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">'/'</span> != *(p<span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">	*p++ = <span class="string">'/'</span>;</span><br><span class="line">	*p = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"dir %s:\n"</span>,fullpath); <span class="comment">//output dir name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == (dp=opendir(fullpath)))</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s[opendir]%s\n"</span>,fullpath,strerror(errno));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">NULL</span> != (dirrp=readdir(dp)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((global_count &lt;= <span class="number">1</span> ))</span><br><span class="line">           <span class="keyword">goto</span> goout;</span><br><span class="line">	<span class="keyword">if</span>((<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">"."</span>)==<span class="number">0</span>) || (<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">".."</span>)==<span class="number">0</span>))</span><br><span class="line">	    <span class="keyword">continue</span>;</span><br><span class="line">	<span class="built_in">strcpy</span>(p,dirrp-&gt;d_name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="number">0</span> == readfile(p))</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    p[<span class="number">-1</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">-1</span> == closedir(dp))</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s[closedir]%s\n"</span>,fullpath,strerror(errno));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">goout:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Usage:%s &lt;Dir name&gt; &lt;List number&gt;\n"</span>,argv[<span class="number">0</span>]+<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fullpath = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*PATH_MAX);</span><br><span class="line">    <span class="built_in">memset</span>(fullpath,<span class="number">0</span>,PATH_MAX);</span><br><span class="line">    global_count=atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">strcpy</span>(fullpath,argv[<span class="number">1</span>]);</span><br><span class="line">    readfile(fullpath);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="C-convert-string-to-number"><a href="#C-convert-string-to-number" class="headerlink" title="C convert string to number"></a>C convert string to number</h5><p>int atoi(const char *nptr);<br>global_count=atoi(argv[2]);</p>
<h5 id="memset"><a href="#memset" class="headerlink" title="memset"></a><a href="https://www.geeksforgeeks.org/memset-c-example/" target="_blank" rel="noopener">memset</a></h5><p>void *memset(void *ptr, int x, size_t n);<br>// ptr ==&gt; Starting address of memory to be filled<br>// x   ==&gt; Value to be filled<br>// n   ==&gt; Number of bytes to be filled starting<br>//         from ptr to be filled</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C program to demonstrate working of memset() </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printArray</span><span class="params">(<span class="keyword">int</span> arr[], <span class="keyword">int</span> n)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) </span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d "</span>, arr[i]); </span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">10</span>; </span><br><span class="line">    <span class="keyword">int</span> arr[n]; </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill whole array with 0. </span></span><br><span class="line">    <span class="built_in">memset</span>(arr, <span class="number">0</span>, n*<span class="keyword">sizeof</span>(arr[<span class="number">0</span>])); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Array after memset()\n"</span>); </span><br><span class="line">    printArray(arr, n); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">50</span>] = <span class="string">"GeeksForGeeks is for programming geeks."</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nBefore memset(): %s\n"</span>, str); </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill 8 characters starting from str[13] with '.' </span></span><br><span class="line">    <span class="built_in">memset</span>(str + <span class="number">13</span>, <span class="string">'.'</span>, <span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>)); </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"After memset():  %s"</span>, str); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="Some-struct"><a href="#Some-struct" class="headerlink" title="Some struct"></a>Some struct</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/include/dirent.h</span></span><br><span class="line"></span><br><span class="line">/* This is the data <span class="built_in">type</span> of directory stream objects.</span><br><span class="line">   The actual structure is opaque to users.  */</span><br><span class="line">typedef struct __dirstream DIR;</span><br><span class="line"></span><br><span class="line">struct __dirstream   </span><br><span class="line">   &#123;   </span><br><span class="line">    void *__fd;    </span><br><span class="line">    char *__data;    </span><br><span class="line">    int __entry_data;    </span><br><span class="line">    char *__ptr;    </span><br><span class="line">    int __entry_ptr;    </span><br><span class="line">    size_t __allocation;    </span><br><span class="line">    size_t __size;    </span><br><span class="line">    __libc_lock_define (, __lock)    </span><br><span class="line">   &#125;; </span><br><span class="line"></span><br><span class="line">struct dirent   </span><br><span class="line">&#123;   </span><br><span class="line"> long d_ino; /* inode number */</span><br><span class="line"> off_t d_off; /* offset to this dirent */</span><br><span class="line"> unsigned short d_reclen; /* length of this d_name */</span><br><span class="line"> unsigned char d_type; /* the <span class="built_in">type</span> of d_name */</span><br><span class="line">long d_ino; / char d_name [NAME_MAX+1]; /* file name (null-terminated) */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/include/asm/stat.h</span></span><br><span class="line"><span class="comment">#define STAT64_HAS_BROKEN_ST_INO        1</span></span><br><span class="line"></span><br><span class="line">/* This matches struct stat64 <span class="keyword">in</span> glibc2.1, hence the absolutely</span><br><span class="line"> * insane amounts of padding around dev_t<span class="string">'s.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct stat64 &#123;</span></span><br><span class="line"><span class="string">        unsigned long long      st_dev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad0[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   __st_ino;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned int    st_mode;</span></span><br><span class="line"><span class="string">        unsigned int    st_nlink;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_uid;</span></span><br><span class="line"><span class="string">        unsigned long   st_gid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_rdev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad3[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        long long       st_size;</span></span><br><span class="line"><span class="string">        unsigned long   st_blksize;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* Number 512-byte blocks allocated. */</span></span><br><span class="line"><span class="string">        unsigned long long      st_blocks;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_atime;</span></span><br><span class="line"><span class="string">        unsigned long   st_atime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_mtime;</span></span><br><span class="line"><span class="string">        unsigned int    st_mtime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_ctime;</span></span><br><span class="line"><span class="string">        unsigned long   st_ctime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_ino;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* We don'</span>t need to memset the whole thing just to initialize the padding */</span><br><span class="line"><span class="comment">#define INIT_STRUCT_STAT64_PADDING(st) do &#123;             \</span></span><br><span class="line">        memset(&amp;st.__pad0, 0, sizeof(st.__pad0));       \</span><br><span class="line">        memset(&amp;st.__pad3, 0, sizeof(st.__pad3));       \</span><br><span class="line">&#125; <span class="keyword">while</span> (0)</span><br><span class="line"></span><br><span class="line"><span class="comment">#else /* __i386__ */</span></span><br><span class="line"></span><br><span class="line">struct <span class="built_in">stat</span> &#123;</span><br><span class="line">        unsigned long   st_dev;</span><br><span class="line">        unsigned long   st_ino;</span><br><span class="line">        unsigned long   st_nlink;</span><br><span class="line"></span><br><span class="line">        unsigned int    st_mode;</span><br><span class="line">        unsigned int    st_uid;</span><br><span class="line">        unsigned int    st_gid;</span><br><span class="line">        unsigned int    __pad0;</span><br><span class="line">        unsigned long   st_rdev;</span><br><span class="line">        long            st_size;</span><br><span class="line">        long            st_blksize;</span><br><span class="line">        long            st_blocks;      /* Number 512-byte blocks allocated. */</span><br><span class="line"></span><br><span class="line">        unsigned long   st_atime;</span><br><span class="line">        unsigned long   st_atime_nsec;</span><br><span class="line">        unsigned long   st_mtime;</span><br><span class="line">        unsigned long   st_mtime_nsec;</span><br><span class="line">        unsigned long   st_ctime;</span><br><span class="line">        unsigned long   st_ctime_nsec;</span><br><span class="line">        long            __unused[3];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="lstat"><a href="#lstat" class="headerlink" title="lstat"></a><a href="http://codewiki.wikidot.com/c:system-calls:lstat" target="_blank" rel="noopener">lstat</a></h5><p>int lstat(const char *path, struct stat *buf);<br>lstat is a system call that is used to determine information about a file based on its filename.<br>lstat is exactly the same as the stat system call. The only difference between the two is when the filename refers to a link. When this is the case, lstat returns information about the link itself, whereas stat returns information about the actual file.    </p>
<p>const char *path    The file path of the file that is being inquired. This can be both relative and absolute.<br>struct stat *buf    A structure where data about the file will be stored. A detailed look at all of the fields in this structure can be found in the struct stat page.<br>return value    Returns a negative value on failure.</p>
<h5 id="File-type"><a href="#File-type" class="headerlink" title="File type"></a>File type</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/usr/include/linux/stat.h</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFMT  00170000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFSOCK 0140000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFLNK  0120000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFREG  0100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFBLK  0060000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFDIR  0040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFCHR  0020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFIFO  0010000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISUID  0004000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISGID  0002000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISVTX  0001000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISLNK(m)      (((m) &amp; S_IFMT) == S_IFLNK) # is link ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISREG(m)      (((m) &amp; S_IFMT) == S_IFREG) # is file ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISDIR(m)      (((m) &amp; S_IFMT) == S_IFDIR) # is dir ? # S_ISDIR(buf.st_mode)==1 means is dir,  ==0 means not dir</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISCHR(m)      (((m) &amp; S_IFMT) == S_IFCHR) # is char ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISBLK(m)      (((m) &amp; S_IFMT) == S_IFBLK) # is blk ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISFIFO(m)     (((m) &amp; S_IFMT) == S_IFIFO) # is fifo ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISSOCK(m)     (((m) &amp; S_IFMT) == S_IFSOCK) # is socket ?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Here is the permission bit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXU 00700</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRUSR 00400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWUSR 00200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXUSR 00100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXG 00070</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRGRP 00040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWGRP 00020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXGRP 00010</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXO 00007</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IROTH 00004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWOTH 00002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXOTH 00001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> abc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    stat(<span class="string">"/home"</span>, &amp;buf);</span><br><span class="line">    abc = buf.st_mode &amp; S_IFDIR;</span><br><span class="line">    <span class="keyword">if</span>(abc == S_IFDIR) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"It's a directory.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> you could </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"file: %s \n"</span>,k); <span class="comment">// output file name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/17/benchmark-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/17/benchmark-tools/" class="post-title-link" itemprop="url">bencharmk tools</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-17 17:06:14" itemprop="dateCreated datePublished" datetime="2020-03-17T17:06:14+08:00">2020-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-05 00:30:50" itemprop="dateModified" datetime="2020-06-05T00:30:50+08:00">2020-06-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/benchmark/" itemprop="url" rel="index">
                    <span itemprop="name">benchmark</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/17/benchmark-tools/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/17/benchmark-tools/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="stress-ng"><a href="#stress-ng" class="headerlink" title="stress-ng"></a>stress-ng</h3><h4 id="filesystem"><a href="#filesystem" class="headerlink" title="filesystem"></a>filesystem</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bogo ops/s (real time) is the value of system performance</span></span><br><span class="line"></span><br><span class="line">$ stress-ng  --hdd 16 --hdd-opts rd-rnd --hdd-opts wr-rnd --hdd-opts fadv-rnd --hdd-write-size 128k --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [67477] dispatching hogs: 16 hdd</span><br><span class="line">stress-ng: info:  [67477] successful run completed <span class="keyword">in</span> 60.17s (1 min, 0.17 secs)</span><br><span class="line">stress-ng: info:  [67477] stressor       bogo ops real time  usr time  sys time   bogo ops/s   bogo ops/s</span><br><span class="line">stress-ng: info:  [67477]                           (secs)    (secs)    (secs)   (real time) (usr+sys time)</span><br><span class="line">stress-ng: info:  [67477] hdd            19033866     60.12    381.16    575.50    316618.18     19896.17</span><br><span class="line">stress-ng: info:  [67477] <span class="keyword">for</span> a 60.17s run time:</span><br><span class="line">stress-ng: info:  [67477]     962.79s available CPU time</span><br><span class="line">stress-ng: info:  [67477]     381.24s user time   ( 39.60%)</span><br><span class="line">stress-ng: info:  [67477]     575.57s system time ( 59.78%)</span><br><span class="line">stress-ng: info:  [67477]     956.81s total time  ( 99.38%)</span><br><span class="line">stress-ng: info:  [67477] load average: 11.29 4.72 1.86</span><br><span class="line"></span><br><span class="line"><span class="comment"># meta</span></span><br><span class="line">$ stress-ng --sequential 16 --class filesystem --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [27612] apparmor stressor will be skipped, AppArmor is not available</span><br><span class="line">stress-ng: info:  [27612] dispatching hogs: 16 <span class="built_in">chdir</span>, 16 chmod, 16 chown, 16 copy-file, 16 dentry, 16 dir, 16 dirdeep, 16 dnotify, 16 dup, 16 eventfd, 16 fallocate, 16 fanotify, 16 fcntl, 16 fiemap, 16 filename, 16 flock, 16 fstat, 16 getdent, 16 handle, 16 inotify, 16 io, 16 iomix, 16 ioprio, 16 lease, 16 link, 16 locka, 16 lockf, 16 lockofd, 16 mknod, 16 open, 16 procfs, 16 rename, 16 symlink, 16 sync-file, 16 utime, 16 xattr</span><br><span class="line"></span><br><span class="line"><span class="comment">#syscall test, no real IO</span></span><br><span class="line">$ stress-ng --<span class="built_in">chdir</span> 8 --chmod 8 --chown 8 --fcntl 8 --filename 8 --flock 8 --fstat 8 --getdent 8 --handle 8 --io 8 -- lockf 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># parallel running</span></span><br><span class="line"><span class="comment"># if you want test IO performance, got the high IO loading from these.</span></span><br><span class="line">$ stress-ng --fallocate 8 --xattr 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># a lot of NFS not support xattr</span></span><br><span class="line">$ stress-ng --fallocate 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># the high IO loading test could got the high IOPS in ext4 with SATA SSD</span></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdb               0.00 100284.00    0.00 15955.50     0.00   452.52    58.08    97.34    6.05    0.00    6.05   0.06  95.05</span><br></pre></td></tr></table></figure>

<h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu <span class="variable">$cores_num</span> --timeout 900</span><br></pre></td></tr></table></figure>

<h4 id="MEM"><a href="#MEM" class="headerlink" title="MEM"></a>MEM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --vm 4 --timeout 900s</span><br><span class="line">$ stress-ng --vm-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.9;&#125;'</span> &lt; /proc/meminfo)k --vm-keep -m 1 -t 30s --metrics-brief</span><br><span class="line">$ stress-ng --mincore 5 --mincore-random --malloc 2 --malloc-bytes 10g --mremap 2 --mremap-bytes 10g --memfd 2 --memfd-bytes 10g --vm-bytes 10g -m 2  -t 600s --metrics-brief</span><br></pre></td></tr></table></figure>

<h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span>  --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># The matrix stressor is a good way to exercise the CPU floating point operations as well as memory and processor data cache. Of all the tests, this one generally heats x86 CPUs the best.</span></span><br><span class="line">$ stress-ng --matrix 0 -t 1m --<span class="built_in">times</span> --metrics-brief</span><br></pre></td></tr></table></figure>

<h4 id="mix"><a href="#mix" class="headerlink" title="mix"></a>mix</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu 2 --matrix 1 --mq 3</span><br><span class="line">$ stress-ng --all 2</span><br><span class="line"></span><br><span class="line">$ stress-ng --seq 1 -x numa,matrix,hdd</span><br><span class="line"><span class="comment">#        --sequential N</span></span><br><span class="line">sequentially run all the stressors one by one <span class="keyword">for</span> a default of 60 seconds. The number of instances of each of the individual stressors to be started is N.  If N  is  less than  zero, <span class="keyword">then</span> the number of CPUs online is used <span class="keyword">for</span> the number of instances.  If N is zero, <span class="keyword">then</span> the number of CPUs <span class="keyword">in</span> the system is used.  Use the --timeout option to specify the duration to run each stressor.</span><br></pre></td></tr></table></figure>

<h4 id="the-others-test"><a href="#the-others-test" class="headerlink" title="the others test"></a>the others test</h4><p>$ stress-ng –seq 1 -x nuam, –sched fifo  -t 30s –times –metrics-brief<br>$ stress-ng –vm 16 –vm-bytes 90% -t 1h –metrics-brief<br>$ stress-ng –cpu 8 –cpu-ops 800000<br>$ stress-ng –cpu 4 –cpu-method fft –cpu-ops 10000 –metrics-brief<br>$ stress-ng –cpu 0 –cpu-method all -t 1h<br>$ stress-ng –random 64<br>#run 64 stressors that are randomly chosen from all the available stressors.</p>
<p>$ stress-ng –cpu 64 –cpu-method all –verify -t 10m –metrics-brief<br>#run 64 instances of all the different cpu stressors and verify that the computations are correct for 10 minutes with a bogo operations summary at the end.</p>
<p>$ stress-ng –sequential 8 –class io -t 5m –times</p>
<h1 id="run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run"><a href="#run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run" class="headerlink" title="run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run."></a>run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run.</h1><p>$ stress-ng –all 0 –maximize –aggressive<br>#run all the stressors (1 instance of each per CPU) simultaneously, maximize the settings (memory sizes, file allocations, etc.) and select the  most  demanding/aggressive options.</p>
<p>$        stress-ng –sequential 4 –class vm –exclude bigheap,brk,stack<br>#run 4 instances of the VM stressors one after each other, excluding the bigheap, brk and stack stressors</p>
<p>$ stress-ng –taskset 0,2-3 –cpu 3<br>#run 3 instances of the CPU stressor and pin them to CPUs 0, 2 and 3.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### cpu-cache</span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">$ stress-ng --sequential 8 --class cpu-cache -t 5m</span><br><span class="line">stress-ng: info:  [13341] apparmor stressor will be skipped, AppArmor is not available</span><br><span class="line">stress-ng: info:  [13341] dispatching hogs: 8 bsearch, 8 cache, 8 heapsort, 8 hsearch, 8 icache, 8 lockbus, 8 lsearch, 8 malloc, 8 matrix, 8 membarrier, 8 memcpy, 8 mergesort, 8 qsort, 8 str, 8 stream, 8 tsearch, 8 vecmath, 8 wcs, 8 zlib</span><br><span class="line"></span><br><span class="line">$ stress-ng --cpu 4 --cache-level 2 --cache-ways 4 -t 30s --metrics-brief</span><br><span class="line">$ stress-ng --cpu 4 --cache-level 3 --cache-ways 4 -t 30s --metrics-brief</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ stress-ng --all 0 --class cpu-cache -t 5m --metrics-brief</span><br></pre></td></tr></table></figure>

<h5 id="cpu-method"><a href="#cpu-method" class="headerlink" title="cpu-method"></a>cpu-method</h5><p>$ stress-ng –cpu 1 –cpu-method matrixprod -t 1m –metrics-brief<br>$ for m in double longdouble matrixprod nsqrt cfloat clongdouble decimal32 decimal128 explog bitops ln2 int64 int128 ackermann int128decimal128 gray euler fibonacci; do stress-ng –cpu 0 –cpu-method $m -t 10s –metrics-brief; done</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># float</span><br><span class="line">double           1000 iterations of a mix of double precision floating point operations</span><br><span class="line">longdouble       1000 iterations of a mix of long double precision floating point operations</span><br><span class="line">matrixprod       matrix  product  of  two  128 × 128 matrices of double floats. Testing on 64 bit x86 hardware shows that this is provides a good mix of memory, cache and floating point operations and is probably the best CPU method to use to make a CPU run hot.</span><br><span class="line">nsqrt            compute sqrt() of long doubles using Newton-Raphson</span><br><span class="line">cfloat           1000 iterations of a mix of floating point complex operations</span><br><span class="line">clongdouble      1000 iterations of a mix of long double floating point complex operations</span><br><span class="line">decimal32        1000 iterations of a mix of 32 bit decimal floating point operations (GCC only)</span><br><span class="line">decimal128       1000 iterations of a mix of 128 bit decimal floating point operations (GCC only)</span><br><span class="line">explog           iterate on n &#x3D; exp(log(n) ÷ 1.00002)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#int</span><br><span class="line">int64            1000 iterations of a mix of 64 bit integer operations</span><br><span class="line">int128           1000 iterations of a mix of 128 bit integer operations (GCC only)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------performance test--------------------------</span><br><span class="line">#logic</span><br><span class="line">jmp              Simple unoptimised compare &gt;, &lt;, &#x3D;&#x3D; and jmp branching</span><br><span class="line">ackermann        Ackermann function: compute A(3, 10), where:</span><br><span class="line">                 A(m, n) &#x3D; n + 1 if m &#x3D; 0;</span><br><span class="line">                 A(m - 1, 1) if m &gt; 0 and n &#x3D; 0;</span><br><span class="line">                 A(m - 1, A(m, n - 1)) if m &gt; 0 and n &gt; 0</span><br><span class="line"># bit</span><br><span class="line">bitops           various bit operations from bithack, namely: reverse bits, parity check, bit count, round to nearest power of 2</span><br><span class="line"># int</span><br><span class="line">gray             calculate binary to gray code and gray code back to binary for integers from 0 to 65535 </span><br><span class="line">fibonacci        compute Fibonacci sequence of 0, 1, 1, 2, 5, 8...</span><br><span class="line"></span><br><span class="line">#float</span><br><span class="line">euler            compute e using n &#x3D; (1 + (1 ÷ n)) ↑ n </span><br><span class="line">ln2              compute ln(2) based on series:</span><br><span class="line">#mix</span><br><span class="line">int128decimal32 1000 iterations of a mix of 128 bit integer and 128 bit decimal floating point operations (GCC only)</span><br><span class="line">#rand hash</span><br><span class="line">djb2a            128 rounds of hash DJB2a (Dan Bernstein hash using the xor variant) on 128 to 1 bytes of random strings</span><br><span class="line">dither           Floyd–Steinberg dithering of a 1024 × 768 random image from 8 bits down to 1 bit of depth.</span><br><span class="line">crc16            compute 1024 rounds of CCITT CRC16 on random data</span><br><span class="line"></span><br><span class="line">-----------------------------------END--------------------------</span><br><span class="line"></span><br><span class="line">#C</span><br><span class="line">callfunc         recursively call 8 argument C function to a depth of 1024 calls and unwind</span><br><span class="line"></span><br><span class="line">#random, hash</span><br><span class="line">jenkin        Jenkin&#39;s integer hash on 128 rounds of 128..1 bytes of random data</span><br><span class="line">hanoi         solve a 21 disc Towers of Hanoi stack using the recursive solution</span><br><span class="line">              hamming          compute Hamming H(8,4) codes on 262144 lots of 4 bit data. This turns 4 bit data into 8 bit Hamming code containing 4 parity bits. For data bits  d1..d4,</span><br><span class="line">                               parity bits are computed as:</span><br><span class="line">                                 p1 &#x3D; d2 + d3 + d4</span><br><span class="line">                                 p2 &#x3D; d1 + d3 + d4</span><br><span class="line">                                 p3 &#x3D; d1 + d2 + d4</span><br><span class="line">                                 p4 &#x3D; d1 + d2 + d3</span><br><span class="line">correlate        perform a 16384 × 1024 correlation of random doubles</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--memthrash-method method</span><br><span class="line">              specify a memthrash stress method. Available memthrash stress methods are described</span><br><span class="line">              as follows:</span><br><span class="line"></span><br><span class="line">              Method           Description</span><br><span class="line">              all              iterate over all the below memthrash methods</span><br><span class="line">              chunk1           memset 1 byte chunks of random data into random locations</span><br><span class="line">              chunk8           memset 8 byte chunks of random data into random locations</span><br><span class="line">              chunk64          memset 64 byte chunks of random data into random locations</span><br><span class="line">              chunk256         memset 256 byte chunks of random data into random locations</span><br><span class="line">              chunkpage        memset page size chunks of random data into random locations</span><br><span class="line">              flip             flip (invert) all bits in ramdom locations</span><br><span class="line">              flush            flush cache line in random locations</span><br><span class="line">              lock             lock randomly choosing locations (Intel x86 CPUs only)</span><br><span class="line">              matrix           treat memory as a 2 × 2 matrix and swap random elements</span><br><span class="line">              memset           memset the memory with random data</span><br><span class="line">              mfence           stores with write serialization (Intel x86 CPUs only)</span><br><span class="line">              prefetch         prefetch data at random memory locations</span><br><span class="line">              random           randomly  run any of the memthrash methods except for &#39;random&#39; and</span><br><span class="line">                               &#39;all&#39;</span><br><span class="line">              spinread         spin loop read the same random location 2^19 times</span><br><span class="line">              spinwrite        spin loop write the same random location 2^19 times</span><br></pre></td></tr></table></figure>

<h5 id="class"><a href="#class" class="headerlink" title="class"></a>class</h5><p>The stress-ng stressors are grouped together in different classes:</p>
<p>cpu - CPU intensive<br>cpu-cache - stress CPU instruction and/or data caches<br>device - raw device driver stressors<br>io - generic input/output<br>interrupt - high interrupt load generators<br>filesystem - file system activity<br>memory - stack, heap, memory mapping, shared memory stressors<br>network - TCP/IP, UDP and UNIX domain socket stressors<br>os - core kernel stressors<br>pipe - pipe and UNIX socket stressors<br>scheduler - force high levels of context switching<br>security - AppArmor stressor<br>vm - Virtual Memory stressor (paging and memory)</p>
<p>–matrix-method method<br>       specify a matrix stress method. Available matrix stress methods are described as follows:</p>
<pre><code>Method           Description
all              iterate over all the below matrix stress methods
add              add two N × N matrices

copy             copy one N × N matrix to another
div              divide an N × N matrix by a scalar
hadamard         Hadamard product of two N × N matrices
frobenius        Frobenius product of two N × N matrices
mean             arithmetic mean of two N × N matrices
mult             multiply an N × N matrix by a scalar
prod             product of two N × N matrices
sub              subtract one N × N matrix from another N × N matrix
trans            transpose an N × N matrix</code></pre><h4 id="performance-info"><a href="#performance-info" class="headerlink" title="performance info"></a>performance info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span> --perf</span><br><span class="line">stress-ng: info:  [68895] dispatching hogs: 16 mq</span><br><span class="line">^Cstress-ng: info:  [68895] unsuccessful run completed <span class="keyword">in</span> 15.95s</span><br><span class="line">stress-ng: info:  [68895] mq:</span><br><span class="line">stress-ng: info:  [68895]            667,942,869,088 CPU Cycles                    41.88 B/sec</span><br><span class="line">stress-ng: info:  [68895]            343,598,563,312 Instructions                  21.54 B/sec (0.514 instr. per cycle)</span><br><span class="line">stress-ng: info:  [68895]              4,273,568,592 Cache References               0.27 B/sec</span><br><span class="line">stress-ng: info:  [68895]                108,195,424 Cache Misses                   6.78 M/sec ( 2.53%)</span><br><span class="line">stress-ng: info:  [68895]             62,069,485,136 Branch Instructions            3.89 B/sec</span><br><span class="line">stress-ng: info:  [68895]              1,391,055,360 Branch Misses                 87.21 M/sec ( 2.24%)</span><br><span class="line">stress-ng: info:  [68895]              4,911,414,496 Bus Cycles                     0.31 B/sec</span><br><span class="line">stress-ng: info:  [68895]            510,787,333,888 Total Cycles                  32.02 B/sec</span><br><span class="line">stress-ng: info:  [68895]                      3,184 Page Faults Minor            199.61 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Page Faults Major              0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  3,924,080 Context Switches               0.25 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    718,208 CPU Migrations                45.03 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Alignment Faults               0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                      3,088 Page Faults User             193.60 /sec</span><br><span class="line">stress-ng: info:  [68895]                         96 Page Faults Kernel             6.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Enter              5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Exit               5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 54,434,816 Kmalloc                        3.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    399,904 Kmalloc Node                  25.07 K/sec</span><br><span class="line">stress-ng: info:  [68895]                231,994,672 Kfree                         14.54 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    139,904 Kmem Cache Alloc               8.77 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     88,848 Kmem Cache Alloc Node          5.57 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    181,568 Kmem Cache Free               11.38 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     59,856 MM Page Alloc                  3.75 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    158,720 MM Page Free                   9.95 K/sec</span><br><span class="line">stress-ng: info:  [68895]                  8,842,656 RCU Utilization                0.55 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    764,352 Sched Migrate Task            47.92 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Sched Move NUMA                0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  6,617,648 Sched Wakeup                   0.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Signal Generate                1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                         80 Signal Deliver                 5.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Entry                     42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Exit                      42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Entry                41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Exit                 41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Writeback Dirty Inode          1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Writeback Dirty Page           0.00 /sec</span><br><span class="line">stress-ng: info:  [68895] <span class="keyword">for</span> a 15.95s run time:</span><br><span class="line">stress-ng: info:  [68895]     255.21s available CPU time</span><br><span class="line">stress-ng: info:  [68895]      25.73s user time   ( 10.08%)</span><br><span class="line">stress-ng: info:  [68895]     181.50s system time ( 71.12%)</span><br><span class="line">stress-ng: info:  [68895]     207.23s total time  ( 81.20%)</span><br><span class="line">stress-ng: info:  [68895] load average: 5.35 1.73 1.08</span><br></pre></td></tr></table></figure>

<h4 id="Verify-mode"><a href="#Verify-mode" class="headerlink" title="Verify mode"></a>Verify mode</h4><p>Some stressors have a verification mode. A stress test is run and the results are checked, if the results are incorrect then stress-ng will flag up a warning error message. Suppose we want to run some exhaustive memory checks on a blob of virtually mapped memory via the vm stressor, enable the –verify mode and this will sanity check that the read/write results on the memory:</p>
<p>$ stress-ng –vm 1 –vm-bytes 2G –verify -v<br>Note that not all stressors have a verify mode, and enabling it will reduce the bogo op stats as there is an extra verification step being invoked.</p>
<h4 id="Generating-major-page-faults"><a href="#Generating-major-page-faults" class="headerlink" title="Generating major page faults"></a>Generating major page faults</h4><p>You can generate major page faults (by accessing a page is not loaded in memory at the time of the fault) and see the page fault rate using:<br>$ stress-ng –fault 0 –perf -t 1m</p>
<p>or with newer kernels use the userfaultfd stressor to force even more major faults:<br>$ stress-ng –userfaultfd 0 –perf -t 1m</p>
<p>Running timers at high frequency can generate a large interrupt load. The timer stressor with an appropriately selected timer frequency can be used to force many hundreds of thousands of interrupts per second, for example, 32 instances at 1MHz:<br>$ stress-ng –timer 32 –timer-freq 1000000</p>
<h3 id="test-case"><a href="#test-case" class="headerlink" title="test case"></a>test case</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -------all cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 0 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------4 cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 4 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------mem test1:---------</span><br><span class="line">stress-ng --malloc 1 --malloc-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.1;&#125;'</span> /proc/meminfo)k  --vm-keep -m 1 --vm-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.1;&#125;'</span> /proc/meminfo)k --mremap 2 --mremap-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.1;&#125;'</span> /proc/meminfo)k --memfd 2 --memfd-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.1;&#125;'</span> /proc/meminfo)k -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test2:---------</span><br><span class="line">stress-ng --mincore 0 --mincore-random -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test3:---------</span><br><span class="line">stress-ng --vm-bytes $(awk <span class="string">'/MemFree/&#123;printf "%d\n", $2 * 0.9;&#125;'</span> /proc/meminfo)k --vm-keep -m 1 -t 600s --metrics-brief</span><br></pre></td></tr></table></figure>

<h3 id="Emulate-some-error-to-test-the-block-device"><a href="#Emulate-some-error-to-test-the-block-device" class="headerlink" title="Emulate some error to test the block device"></a>Emulate some error to test the block device</h3><h4 id="dm-delay"><a href="#dm-delay" class="headerlink" title="dm-delay"></a><a href="https://enodev.fr/posts/emulate-a-slow-block-device-with-dm-delay.html#" target="_blank" rel="noopener">dm-delay</a></h4><p>Device-Mapper’s “delay” target delays reads and/or writes and maps them to different devices.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ sudo modprobe brd rd_nr&#x3D;1 rd_size&#x3D;1048576</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">readwrite&#x3D;randread</span><br><span class="line">blocksize&#x3D;4k</span><br><span class="line">ioengine&#x3D;sync</span><br><span class="line">filename&#x3D;&#x2F;dev&#x2F;ram0</span><br><span class="line">time_based&#x3D;1</span><br><span class="line">runtime&#x3D;10</span><br><span class="line"></span><br><span class="line">DDR 1333</span><br><span class="line">Jobs: 1 (f&#x3D;1): [r(1)][100.0%][r&#x3D;1471MiB&#x2F;s,w&#x3D;0KiB&#x2F;s][r&#x3D;377k,w&#x3D;0 IOPS][eta 00m:00s]</span><br><span class="line">rw: (groupid&#x3D;0, jobs&#x3D;1): err&#x3D; 0: pid&#x3D;13487: Thu Jun  4 22:43:25 2020</span><br><span class="line">   read: IOPS&#x3D;361k, BW&#x3D;1411MiB&#x2F;s (1480MB&#x2F;s)(13.8GiB&#x2F;10001msec)</span><br><span class="line">    clat (nsec): min&#x3D;790, max&#x3D;124854, avg&#x3D;1563.39, stdev&#x3D;935.07</span><br><span class="line">     lat (nsec): min&#x3D;984, max&#x3D;125042, avg&#x3D;1757.85, stdev&#x3D;978.84</span><br><span class="line">    clat percentiles (nsec):</span><br><span class="line">     |  1.00th&#x3D;[ 1240],  5.00th&#x3D;[ 1304], 10.00th&#x3D;[ 1336], 20.00th&#x3D;[ 1368],</span><br><span class="line">     | 30.00th&#x3D;[ 1384], 40.00th&#x3D;[ 1400], 50.00th&#x3D;[ 1432], 60.00th&#x3D;[ 1464],</span><br><span class="line">     | 70.00th&#x3D;[ 1496], 80.00th&#x3D;[ 1560], 90.00th&#x3D;[ 1752], 95.00th&#x3D;[ 2352],</span><br><span class="line">     | 99.00th&#x3D;[ 3376], 99.50th&#x3D;[ 4080], 99.90th&#x3D;[14784], 99.95th&#x3D;[24960],</span><br><span class="line">     | 99.99th&#x3D;[31360]</span><br><span class="line">   bw (  MiB&#x2F;s): min&#x3D; 1004, max&#x3D; 1476, per&#x3D;99.79%, avg&#x3D;1408.26, stdev&#x3D;144.72, samples&#x3D;19</span><br><span class="line">   iops        : min&#x3D;257224, max&#x3D;377934, avg&#x3D;360514.11, stdev&#x3D;37048.52, samples&#x3D;19</span><br><span class="line">  lat (nsec)   : 1000&#x3D;0.01%</span><br><span class="line">  lat (usec)   : 2&#x3D;91.75%, 4&#x3D;7.64%, 10&#x3D;0.49%, 20&#x3D;0.03%, 50&#x3D;0.09%</span><br><span class="line">  lat (usec)   : 100&#x3D;0.01%, 250&#x3D;0.01%</span><br><span class="line">  cpu          : usr&#x3D;27.40%, sys&#x3D;72.48%, ctx&#x3D;954, majf&#x3D;0, minf&#x3D;9</span><br><span class="line">  IO depths    : 1&#x3D;100.0%, 2&#x3D;0.0%, 4&#x3D;0.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     submit    : 0&#x3D;0.0%, 4&#x3D;100.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     complete  : 0&#x3D;0.0%, 4&#x3D;100.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     issued rwt: total&#x3D;3613043,0,0, short&#x3D;0,0,0, dropped&#x3D;0,0,0</span><br><span class="line">     latency   : target&#x3D;0, window&#x3D;0, percentile&#x3D;100.00%, depth&#x3D;1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw&#x3D;1411MiB&#x2F;s (1480MB&#x2F;s), 1411MiB&#x2F;s-1411MiB&#x2F;s (1480MB&#x2F;s-1480MB&#x2F;s), io&#x3D;13.8GiB (14.8GB), run&#x3D;10001-10001msec</span><br><span class="line"></span><br><span class="line"># Create device delaying rw operation for 500ms</span><br><span class="line">$ echo &quot;0 $(blockdev --getsz &#x2F;dev&#x2F;ram0) delay &#x2F;dev&#x2F;ram0 0 500&quot; | dmsetup create delayed</span><br><span class="line">$ ls -l &#x2F;dev&#x2F;mapper&#x2F;delayed </span><br><span class="line">lrwxrwxrwx 1 root root 7 6   4 22:47 &#x2F;dev&#x2F;mapper&#x2F;delayed -&gt; ..&#x2F;dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename&#x3D;&#x2F;dev&#x2F;dm-0</span><br><span class="line">readwrite&#x3D;randread</span><br><span class="line">blocksize&#x3D;4k</span><br><span class="line">ioengine&#x3D;sync</span><br><span class="line">time_based&#x3D;1</span><br><span class="line">runtime&#x3D;10</span><br><span class="line"></span><br><span class="line">Starting 1 process</span><br><span class="line">Jobs: 1 (f&#x3D;1): [r(1)][100.0%][r&#x3D;8KiB&#x2F;s,w&#x3D;0KiB&#x2F;s][r&#x3D;2,w&#x3D;0 IOPS][eta 00m:00s]</span><br><span class="line">random: (groupid&#x3D;0, jobs&#x3D;1): err&#x3D; 0: pid&#x3D;13873: Thu Jun  4 22:56:44 2020</span><br><span class="line">   read: IOPS&#x3D;1, BW&#x3D;8007B&#x2F;s (8007B&#x2F;s)(80.0KiB&#x2F;10231msec)</span><br><span class="line">    clat (msec): min&#x3D;503, max&#x3D;516, avg&#x3D;511.50, stdev&#x3D; 2.97</span><br><span class="line">     lat (msec): min&#x3D;503, max&#x3D;516, avg&#x3D;511.50, stdev&#x3D; 2.97</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th&#x3D;[  506],  5.00th&#x3D;[  506], 10.00th&#x3D;[  510], 20.00th&#x3D;[  510],</span><br><span class="line">     | 30.00th&#x3D;[  514], 40.00th&#x3D;[  514], 50.00th&#x3D;[  514], 60.00th&#x3D;[  514],</span><br><span class="line">     | 70.00th&#x3D;[  514], 80.00th&#x3D;[  514], 90.00th&#x3D;[  514], 95.00th&#x3D;[  518],</span><br><span class="line">     | 99.00th&#x3D;[  518], 99.50th&#x3D;[  518], 99.90th&#x3D;[  518], 99.95th&#x3D;[  518],</span><br><span class="line">     | 99.99th&#x3D;[  518]</span><br><span class="line">   bw (  KiB&#x2F;s): min&#x3D;    8, max&#x3D;    8, per&#x3D;100.00%, avg&#x3D; 8.00, stdev&#x3D; 0.00, samples&#x3D;19</span><br><span class="line">   iops        : min&#x3D;    2, max&#x3D;    2, avg&#x3D; 2.00, stdev&#x3D; 0.00, samples&#x3D;19</span><br><span class="line">  lat (msec)   : 750&#x3D;100.00%</span><br><span class="line">  cpu          : usr&#x3D;0.00%, sys&#x3D;0.02%, ctx&#x3D;20, majf&#x3D;0, minf&#x3D;6</span><br><span class="line">  IO depths    : 1&#x3D;100.0%, 2&#x3D;0.0%, 4&#x3D;0.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     submit    : 0&#x3D;0.0%, 4&#x3D;100.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     complete  : 0&#x3D;0.0%, 4&#x3D;100.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     issued rwt: total&#x3D;20,0,0, short&#x3D;0,0,0, dropped&#x3D;0,0,0</span><br><span class="line">     latency   : target&#x3D;0, window&#x3D;0, percentile&#x3D;100.00%, depth&#x3D;1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw&#x3D;8007B&#x2F;s (8007B&#x2F;s), 8007B&#x2F;s-8007B&#x2F;s (8007B&#x2F;s-8007B&#x2F;s), io&#x3D;80.0KiB (81.9kB), run&#x3D;10231-10231msec</span><br><span class="line"></span><br><span class="line">Disk stats (read&#x2F;write):</span><br><span class="line">    dm-0: ios&#x3D;20&#x2F;0, merge&#x3D;0&#x2F;0, ticks&#x3D;9720&#x2F;0, in_queue&#x3D;10140, util&#x3D;99.14%, aggrios&#x3D;0&#x2F;0, aggrmerge&#x3D;0&#x2F;0, aggrticks&#x3D;0&#x2F;0, aggrin_queue&#x3D;0, aggrutil&#x3D;0.00%</span><br><span class="line">  ram0: ios&#x3D;0&#x2F;0, merge&#x3D;0&#x2F;0, ticks&#x3D;0&#x2F;0, in_queue&#x3D;0, util&#x3D;0.00%</span><br><span class="line"></span><br><span class="line"># Create a block device that delays reads for 500 ms and writes for 300 ms</span><br><span class="line">size&#x3D;$(blockdev --getsize &#x2F;dev&#x2F;ram0) # Size in 512-bytes sectors</span><br><span class="line">$ echo &quot;0 $(blockdev --getsize &#x2F;dev&#x2F;ram0) delay &#x2F;dev&#x2F;ram0 0 500 &#x2F;dev&#x2F;ram0 0 300&quot; | dmsetup create delayed</span><br><span class="line"></span><br><span class="line">$ dmsetup remove &#x2F;dev&#x2F;mapper&#x2F;delayed</span><br></pre></td></tr></table></figure>
<h4 id="dm-linear"><a href="#dm-linear" class="headerlink" title="dm-linear"></a>dm-linear</h4><p>The dm-linear target maps a linear range of blocks of the device-mapper device onto a linear range of a backend device. dm-linear is the basic building block of logical volume managers such as LVM.</p>
<h4 id="dm-flakey"><a href="#dm-flakey" class="headerlink" title="dm-flakey"></a>dm-flakey</h4><p>This target is the same as the linear target except that it exhibits unreliable behaviour periodically.  It’s been found useful in simulating failing devices for testing purposes.</p>
<ul>
<li>drop_writes All write I/Os are silently ignored and dropped. Read I/Os are handled correctly.</li>
<li>error_writes All write I/Os are failed with an error signaled. Read I/Os are handled correctly.</li>
<li>corrupt_bio_byte During the down time, replace the Nth byte of the data of each read or write block I/O with a specified value.<br>The default error mode is to fail all I/O requests during the down time of the simulation cycle.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">tabled parameters:</span><br><span class="line">&lt;dev path&gt; &lt;offset&gt; &lt;up interval&gt; &lt;down interval&gt;  [&lt;num_features&gt; [&lt;feature arguments&gt;]]</span><br><span class="line">$ dmsetup create test --table &#39;0 123 flakey &#x2F;dev&#x2F;sda1 0 4 8&#39;</span><br><span class="line">$  file &#x2F;dev&#x2F;mapper&#x2F;dm_test0 </span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;dm_test0: symbolic link to ..&#x2F;dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename&#x3D;&#x2F;dev&#x2F;dm-0</span><br><span class="line">#readwrite&#x3D;randrw</span><br><span class="line">readwrite&#x3D;randread</span><br><span class="line">blocksize&#x3D;4k</span><br><span class="line">ioengine&#x3D;sync</span><br><span class="line">time_based&#x3D;1</span><br><span class="line">runtime&#x3D;130</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio-3.1</span><br><span class="line">Starting 1 process</span><br><span class="line">fio: io_u error on file &#x2F;dev&#x2F;dm-0: Input&#x2F;output error: read offset&#x3D;0, buflen&#x3D;4096</span><br><span class="line">random: No I&#x2F;O performed by sync, perhaps try --debug&#x3D;io option for details?</span><br><span class="line">fio: pid&#x3D;16261, err&#x3D;5&#x2F;file:io_u.c:1756, func&#x3D;io_u error, error&#x3D;Input&#x2F;output error</span><br><span class="line"></span><br><span class="line">random: (groupid&#x3D;0, jobs&#x3D;1): err&#x3D; 5 (file:io_u.c:1756, func&#x3D;io_u error, error&#x3D;Input&#x2F;output error): pid&#x3D;16261: Fri Jun  5 00:29:08 2020</span><br><span class="line">  cpu          : usr&#x3D;0.00%, sys&#x3D;0.00%, ctx&#x3D;0, majf&#x3D;0, minf&#x3D;17</span><br><span class="line">  IO depths    : 1&#x3D;100.0%, 2&#x3D;0.0%, 4&#x3D;0.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     submit    : 0&#x3D;0.0%, 4&#x3D;100.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     complete  : 0&#x3D;50.0%, 4&#x3D;50.0%, 8&#x3D;0.0%, 16&#x3D;0.0%, 32&#x3D;0.0%, 64&#x3D;0.0%, &gt;&#x3D;64&#x3D;0.0%</span><br><span class="line">     issued rwt: total&#x3D;1,0,0, short&#x3D;0,0,0, dropped&#x3D;0,0,0</span><br><span class="line">     latency   : target&#x3D;0, window&#x3D;0, percentile&#x3D;100.00%, depth&#x3D;1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line"></span><br><span class="line">Disk stats (read&#x2F;write):</span><br><span class="line">    dm-0: ios&#x3D;0&#x2F;0, merge&#x3D;0&#x2F;0, ticks&#x3D;0&#x2F;0, in_queue&#x3D;0, util&#x3D;0.00%, aggrios&#x3D;0&#x2F;0, aggrmerge&#x3D;0&#x2F;0, aggrticks&#x3D;0&#x2F;0, aggrin_queue&#x3D;0, aggrutil&#x3D;0.00%</span><br><span class="line">  sda: ios&#x3D;0&#x2F;0, merge&#x3D;0&#x2F;0, ticks&#x3D;0&#x2F;0, in_queue&#x3D;0, util&#x3D;0.00%</span><br><span class="line"></span><br><span class="line">[18800.528564] buffer_io_error: 110 callbacks suppressed</span><br><span class="line">[18800.528569] Buffer I&#x2F;O error on dev dm-0, logical block 0, async page read</span><br><span class="line">[18800.528582] Buffer I&#x2F;O error on dev dm-0, logical block 1, async page read</span><br><span class="line">[18800.528587] Buffer I&#x2F;O error on dev dm-0, logical block 2, async page read</span><br><span class="line">[18800.528591] Buffer I&#x2F;O error on dev dm-0, logical block 3, async page read</span><br><span class="line">[18800.528596] Buffer I&#x2F;O error on dev dm-0, logical block 4, async page read</span><br><span class="line">[18800.528600] Buffer I&#x2F;O error on dev dm-0, logical block 5, async page read</span><br><span class="line">[18800.528604] Buffer I&#x2F;O error on dev dm-0, logical block 6, async page read</span><br><span class="line">[18800.528608] Buffer I&#x2F;O error on dev dm-0, logical block 7, async page read</span><br></pre></td></tr></table></figure>
<p>$ dmsetup suspend /dev/dm-0<br>$ dmsetup resume /dev/dm-0</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/17/nvme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/17/nvme/" class="post-title-link" itemprop="url">nvme test</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-17 11:27:38" itemprop="dateCreated datePublished" datetime="2020-03-17T11:27:38+08:00">2020-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 01:16:01" itemprop="dateModified" datetime="2020-03-31T01:16:01+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/block/" itemprop="url" rel="index">
                    <span itemprop="name">block</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/17/nvme/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/17/nvme/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>NAND P/E Cycles = amount of program / erase cycles NAND can do before wearing out<ul>
<li>WAF = NAND writes / host writes</li>
</ul>
</li>
<li>TBW or PBW – amount of host writes to SSD before wearing out<ul>
<li>TBW = drive capacity * cycles / WAF</li>
</ul>
</li>
<li>DWPD (drive writes per day): amount of data you can write to device each day of the warranty (typically 5 years) without wearing out<ul>
<li>DWPD = TBW/365/5/drive capacity</li>
</ul>
</li>
</ul>
<ol>
<li>Create partition smaller than total user capacity of SSD</li>
<li>Limit max LBA of drive through vendor specific tools</li>
<li>Create a namespace smaller than total user capacity</li>
<li>Limit application use to smaller LBA range</li>
</ol>
<p><a href="https://events.static.linuxfound.org/sites/events/files/slides/lemoal-nvme-polling-vault-2017-final_0.pdf" target="_blank" rel="noopener">nvme hybird polling</a><br>I/O models</p>
<ul>
<li><p>IRQ vs polling</p>
<ul>
<li>NVM is coming ! Is this relevant ?</li>
<li>Linux implementation</li>
</ul>
</li>
<li><p>Block Layer and NVMe driver</p>
<ul>
<li>Evaluation Results</li>
<li>Classic polling vs Hybrid polling</li>
<li>Impact of process scheduling</li>
<li>Comparison with user level drivers</li>
</ul>
</li>
<li><p>Implemented by blk_mq_poll</p>
<ul>
<li>block-mq enabled devices only</li>
<li>Device queue flagged with “poll enabled”<ul>
<li>Can be controlled through sysfs</li>
<li>Enabled by default for devices supporting it, e.g. NVMe</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To enable it, you echo 1 to /sys/block/&lt;dev&gt;/queue/io_poll.</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt;  /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">$ cat  /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>Polling is tried for any block I/O belonging to a high-priority I/O context (IOCB_HIPRI)</li>
<li>IRQs are NOT disabled<ul>
<li>ISR is still executed as the device signals completions</li>
<li>But ISR sees a completion slot already processed</li>
</ul>
</li>
</ul>
<p>6us average latency with IRQ, 4.5us with polling</p>
<ul>
<li>25% lower latency with polling</li>
<li>166 KIOPS vs 222 KIOPS</li>
<li><code>But 100% load on the polling CPU</code></li>
<li>Only 32% CPU load with IRQ model</li>
</ul>
<p>Adaptive hybrid polling gives the same average latency of 4.5us as classic polling</p>
<ul>
<li>But with only 58% CPU load</li>
<li>32% with IRQ model</li>
<li>Fixed time polling allows controlling the CPU vs latency trade-off</li>
<li>IRQ like average latency and CPU load for high polling delay</li>
<li>Better use the IRQ model</li>
<li>Lower CPU loads with a small average latency degradation achieved with intermediate polling delay</li>
</ul>
<p><code>If I use NVME, if you have the top CPU, you could enable the polling, if not , irq is the better choice</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/nvme0n1/queue/io_poll_delay</span><br><span class="line">-1</span><br><span class="line"><span class="comment"># -1 class polling (default)</span></span><br><span class="line"><span class="comment"># 0 means adaptive hybird polling</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/block/nvme0n1/queue/io_poll_delay</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|&lt;------------------------Application Perecived I&#x2F;O latency---------------------------------&gt;|</span><br><span class="line">IRQ      syscall  BIO_stack  Device_driver  CS             sleep            CS  BIO_stack </span><br><span class="line">                                                                            | (wake)</span><br><span class="line">                                                               CS ISR -------</span><br><span class="line">                                                               |(IRQ)</span><br><span class="line">		                    command execution-----------   </span><br><span class="line"></span><br><span class="line">Polling  syscall  BIO_stack  Device_driver    Are you done ?    BIO_stack&lt;-------Gain-------&gt;| </span><br><span class="line">                                                 |</span><br><span class="line">                                           command execution</span><br><span class="line"></span><br><span class="line">Hybrid   syscall  BIO_stack  Device_driver  cs sleep cs  done?  BIO_stack&lt;-------Gain-------&gt;| </span><br><span class="line">                                                     |(wake)|</span><br><span class="line">                                      Timer IRQ --&gt; ISR     |</span><br><span class="line">						     command execution</span><br></pre></td></tr></table></figure>
<h4 id="Software-optimization"><a href="#Software-optimization" class="headerlink" title="Software optimization"></a>Software optimization</h4><ul>
<li>System call (VFS)<ul>
<li>Optimizations introduced with kernel 4.10</li>
</ul>
</li>
<li>BIO stack<ul>
<li>blk-mq already very efficient</li>
</ul>
</li>
<li>Device driver<ul>
<li>NVMe driver submission and completion paths are very short</li>
</ul>
</li>
</ul>
<p><a href="https://metebalci.com/blog/a-quick-tour-of-nvm-express-nvme/" target="_blank" rel="noopener">I’m copy the article, just read it</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">$ nvme --smart-log /dev/nvme0</span><br><span class="line">Smart Log <span class="keyword">for</span> NVME device:nvme0 namespace-id:ffffffff</span><br><span class="line">critical_warning                    : 0</span><br><span class="line">temperature                         : 35 C</span><br><span class="line">available_spare                     : 100%</span><br><span class="line">available_spare_threshold           : 0%</span><br><span class="line">percentage_used                     : 0%</span><br><span class="line">data_units_read                     : 320,346,034</span><br><span class="line">data_units_written                  : 441,545,307</span><br><span class="line">host_read_commands                  : 16,537,842,223</span><br><span class="line">host_write_commands                 : 19,148,305,649</span><br><span class="line">controller_busy_time                : 3,505</span><br><span class="line">power_cycles                        : 50</span><br><span class="line">power_on_hours                      : 16,079</span><br><span class="line">unsafe_shutdowns                    : 33</span><br><span class="line">media_errors                        : 0</span><br><span class="line">num_err_log_entries                 : 0</span><br><span class="line">Warning Temperature Time            : 0</span><br><span class="line">Critical Composite Temperature Time : 0</span><br><span class="line">Thermal Management T1 Trans Count   : 0</span><br><span class="line">Thermal Management T2 Trans Count   : 0</span><br><span class="line">Thermal Management T1 Total Time    : 0</span><br><span class="line">Thermal Management T2 Total Time    : 0</span><br><span class="line"></span><br><span class="line">nvme error-log /dev/nvme0</span><br><span class="line">Error Log Entries <span class="keyword">for</span> device:nvme0 entries:64</span><br><span class="line">.................</span><br><span class="line"> Entry[ 0]</span><br><span class="line">.................</span><br><span class="line">error_count  : 0</span><br><span class="line">sqid         : 0</span><br><span class="line">cmdid        : 0</span><br><span class="line">status_field : 0(SUCCESS: The <span class="built_in">command</span> completed successfully)</span><br><span class="line">parm_err_loc : 0</span><br><span class="line">lba          : 0</span><br><span class="line">nsid         : 0</span><br><span class="line">vs           : 0</span><br><span class="line">cs           : 0</span><br><span class="line">.................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Entry[63]</span><br><span class="line">.................</span><br><span class="line">error_count  : 0</span><br><span class="line">sqid         : 0</span><br><span class="line">cmdid        : 0</span><br><span class="line">status_field : 0(SUCCESS: The <span class="built_in">command</span> completed successfully)</span><br><span class="line">parm_err_loc : 0</span><br><span class="line">lba          : 0</span><br><span class="line">nsid         : 0</span><br><span class="line">vs           : 0</span><br><span class="line">cs           : 0</span><br><span class="line">.................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ nvme get-log /dev/nvme0 --<span class="built_in">log</span>-id=2 --<span class="built_in">log</span>-len=512</span><br><span class="line">Device:nvme0 <span class="built_in">log</span>-id:2 namespace-id:0xffffffff</span><br><span class="line">       0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span><br><span class="line">0000: 00 33 01 64 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">".3.d............"</span></span><br><span class="line">0010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"................"</span></span><br><span class="line">0020: b2 17 18 13 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"................"</span></span><br><span class="line">0030: 5b 72 51 1a 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"[rQ............."</span></span><br><span class="line">0040: 2f 72 bb d9 03 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"/r.............."</span></span><br><span class="line">0050: f1 f4 53 75 04 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"..Su............"</span></span><br><span class="line">0060: b1 0d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"................"</span></span><br><span class="line">0070: 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"2..............."</span></span><br><span class="line">0080: cf 3e 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">".&gt;.............."</span></span><br><span class="line">0090: 21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">"!..............."</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ nvme list</span><br><span class="line">Node             SN                   Model                                    Namespace Usage                      Format           FW Rev</span><br><span class="line">---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------</span><br><span class="line">/dev/nvme0n1     PHKS00000000000000   INTEL SSDPED1K375GA                      1         375.08  GB / 375.08  GB      4 KiB +  0 B   E2010435</span><br><span class="line"></span><br><span class="line">$ nvme list-ns /dev/nvme0n1</span><br><span class="line">NVMe Status:INVALID_NS: The namespace or the format of that namespace is invalid(400b) NSID:0</span><br><span class="line"></span><br><span class="line">$ nvme fw-download /dev/nvme0n1 -f &lt;fw binary&gt;</span><br><span class="line">$ nvme fw-commit /dev/nvme0n1 -s 1 -a 1</span><br><span class="line">$ nvme reset /dev/nvme0 </span><br><span class="line"></span><br><span class="line"><span class="comment">#secure format</span></span><br><span class="line">$ nvme format /dev/nvme0 –s 1</span><br><span class="line">SES = 0 results <span class="keyword">in</span> drive being formatted and trimmed</span><br><span class="line">SES = 1 <span class="keyword">for</span> Block Erase – low level block erase on media (physically erase NAND blocks, or overwrite with 0 on SCM)</span><br><span class="line">SES = 2 <span class="keyword">for</span> Crypto Erase - change media encryption key</span><br><span class="line">-l <span class="keyword">for</span> LBA format, find capabilities <span class="keyword">in</span> NVMe identify controller -t timeout <span class="keyword">for</span> devices that will take a long time</span><br><span class="line">-p <span class="keyword">for</span> protection information with variable sector size</span><br><span class="line"></span><br><span class="line"><span class="comment">## for more info </span></span><br><span class="line">Format NVM, <span class="built_in">command</span> dword 10</span><br><span class="line"></span><br><span class="line">Sanitize (not widely supported yet)</span><br><span class="line">$ nvme sanitize</span><br><span class="line">* Block Erase – low level block erase on media (physically erase NAND blocks)</span><br><span class="line">* Crypto Erase - change media encryption key</span><br><span class="line">* Overwrite – overwrite with data patterns (not good or recommended <span class="keyword">for</span> NAND based SSDs due to endurance)</span><br></pre></td></tr></table></figure>

<h3 id="create-mdraid-for-nvme-ssd"><a href="#create-mdraid-for-nvme-ssd" class="headerlink" title="create mdraid for nvme ssd"></a>create mdraid for nvme ssd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ mdadm -C /dev/md0 /dev/nvme[0-3]n1 –n 4 –e imsm</span><br><span class="line">$ mdadm -C /dev/md0 /dev/nvme[0-3]n1 –n 4 –e imsm</span><br><span class="line"></span><br><span class="line"><span class="comment">## I/O polling mode was introduced with linux 4.4, in polling mode the cpu continuously checks if the I/O command completed</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">bash: <span class="built_in">echo</span>: write error: Invalid argument</span><br><span class="line"></span><br><span class="line"><span class="comment">## Hybird polling mode was introduced in linux kenrel 4.10, hybrid polling mode improvded QD1 performance closer to that of polling mode performance, but with lower cpu utilizaion</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/block/nvme0n1/queue/io_poll_delay</span><br><span class="line">0=hybrid, 1 = always poll( default )</span><br><span class="line"></span><br><span class="line">block-mq enabled devices only</span><br><span class="line">Device queue flagged with “poll enabled</span><br><span class="line"></span><br><span class="line">CPU frequency    &gt;  3.0GHz</span><br><span class="line">Hyper threading     <span class="built_in">disable</span></span><br><span class="line">EIST(Enhanced intel speed step technology)    disabled</span><br><span class="line">intel Turbo mode    <span class="built_in">disable</span></span><br><span class="line">C-states            <span class="built_in">disable</span></span><br><span class="line">P-states            <span class="built_in">disable</span></span><br><span class="line">CPU Governor(os)    performance mode</span><br><span class="line">IRQ balancing(os)   disabled</span><br><span class="line">SMP Affinity        <span class="built_in">set</span> interrupts to run <span class="keyword">in</span> the proper CPU cores</span><br><span class="line">I/O polling or Hybrid mode    Enabled</span><br></pre></td></tr></table></figure>
<p>Linux flow of command execution on NVME SSDs<br>User app requestion IO -&gt; kernel processes IO request and sends to device driver -&gt; device driver processes the requests(create SQ entry, rings doorbell register) -&gt; device processes the requests(read sq entry, processes IO, create cq entry, signals MSI-x to host) -&gt; kernel call device driver to handle the completion -&gt; device driver ack, that the entry in CQ has been processed</p>
<p>IO execution in SPDK<br>User app requestion IO -&gt; SPDK userspace device driver process the requests(create SQ entry, rings doorbell register) -&gt; device processes the requestion(read sq entry, processes IO, create cq entry) -&gt; user application polls SPDK for IO completion -&gt; spdk call user application completion callback when IO is complete</p>
<p>cat /proc/version /proc/cpuinfo /proc/meminfo /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor<br>lspci -v<br>nvme list</p>
<p>#disable IRQ balance<br>set SMP affinity<br>systemctl stop irqbalance<br>folders=/proc/irq/*<br>for folder in $folders<br>do<br>  files=”$folder/*”<br>  for file in $files<br>  do<br>     if [[ $file == *”nvme”* ]]<br>     then<br>        echo $file<br>        contents=$(cat $folder/affinity_hint)<br>        echo $contents &gt; $folder/smp_affinity<br>        cat $folder/smp_affinity<br>     fi<br>  done<br>done</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line">$ nvme id-ctrl -H &#x2F;dev&#x2F;nvme0n1</span><br><span class="line">NVME Identify Controller:</span><br><span class="line">vid       : 0x8086                  # vid is PCI Vendor ID (so Samsung in this case), 0x144d as in the lspci output.</span><br><span class="line">ssvid     : 0x8086                  # ssvid is PCI Subsystem Vendor ID    </span><br><span class="line">sn        : PHK000000000000000</span><br><span class="line">mn        : INTEL SSDPED1K375GA</span><br><span class="line">fr        : E2010435</span><br><span class="line">rab       : 0</span><br><span class="line">ieee      : 5cd2e4</span><br><span class="line">cmic      : 0                       # the Controller Multi-Path I&#x2F;O and Namespace Sharing Capabilities.</span><br><span class="line">  [3:3] : 0	ANA not supported</span><br><span class="line">  [2:2] : 0	PCI</span><br><span class="line">  [1:1] : 0	Single Controller</span><br><span class="line">  [0:0] : 0	Single Port</span><br><span class="line"></span><br><span class="line">mdts      : 5                       # mdts is Maximum Data Transfer Size. </span><br><span class="line">                                    # It is reported as a power of two and in units of minimum memory page size. mdts&#x3D;5 here</span><br><span class="line">                                    # so 2⁵ &#x3D; 32. We will see the minimum memory page size (MPSMIN) as 4K below. So MDTS is 32 * 4K &#x3D; 128K.</span><br><span class="line">cntlid    : 0</span><br><span class="line">ver       : 0</span><br><span class="line">rtd3r     : 0</span><br><span class="line">rtd3e     : 0</span><br><span class="line">oaes      : </span><br><span class="line">  [9:9] : 0	Firmware Activation Notices Not Supported</span><br><span class="line">  [8:8] : 0	Namespace Attribute Changed Event Not Supported</span><br><span class="line"></span><br><span class="line">ctratt    : 0</span><br><span class="line">  [5:5] : 0	Predictable Latency Mode Not Supported</span><br><span class="line">  [4:4] : 0	Endurance Groups Not Supported</span><br><span class="line">  [3:3] : 0	Read Recovery Levels Not Supported</span><br><span class="line">  [2:2] : 0	NVM Sets Not Supported</span><br><span class="line">  [1:1] : 0	Non-Operational Power State Permissive Not Supported</span><br><span class="line">  [0:0] : 0	128-bit Host Identifier Not Supported</span><br><span class="line"></span><br><span class="line">rrls      : 0</span><br><span class="line">oacs      : 0x7                    # Optional Admin Command Support</span><br><span class="line">  [8:8] : 0	Doorbell Buffer Config Not Supported</span><br><span class="line">  [7:7] : 0	Virtualization Management Not Supported</span><br><span class="line">  [6:6] : 0	NVMe-MI Send and Receive Not Supported</span><br><span class="line">  [5:5] : 0	Directives Not Supported</span><br><span class="line">  [4:4] : 0	Device Self-test Not Supported</span><br><span class="line">  [3:3] : 0	NS Management and Attachment Not Supported</span><br><span class="line">  [2:2] : 0x1	FW Commit and Download Supported</span><br><span class="line">  [1:1] : 0x1	Format NVM Supported</span><br><span class="line">  [0:0] : 0x1	Security Send and Receive Supported</span><br><span class="line"></span><br><span class="line">acl       : 3</span><br><span class="line">aerl      : 3</span><br><span class="line">frmw      : 0x2                    # firmware update</span><br><span class="line">  [4:4] : 0	Firmware Activate Without Reset Not Supported</span><br><span class="line">  [3:1] : 0x1	Number of Firmware Slots</span><br><span class="line">  [0:0] : 0	Firmware Slot 1 Read&#x2F;Write</span><br><span class="line"></span><br><span class="line">lpa       : 0x2</span><br><span class="line">  [3:3] : 0	Telemetry host&#x2F;controller initiated log page Not Suporrted</span><br><span class="line">  [2:2] : 0	Extended data for Get Log Page Not Supported</span><br><span class="line">  [1:1] : 0x1	Command Effects Log Page Supported</span><br><span class="line">  [0:0] : 0	SMART&#x2F;Health Log Page per NS Not Supported</span><br><span class="line"></span><br><span class="line">elpe      : 63</span><br><span class="line">npss      : 0</span><br><span class="line">avscc     : 0</span><br><span class="line">  [0:0] : 0	Admin Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">apsta     : 0</span><br><span class="line">  [0:0] : 0	Autonomous Power State Transitions Not Supported</span><br><span class="line"></span><br><span class="line">wctemp    : 0</span><br><span class="line">cctemp    : 0</span><br><span class="line">mtfa      : 0</span><br><span class="line">hmpre     : 0</span><br><span class="line">hmmin     : 0</span><br><span class="line">tnvmcap   : 0                      # Total NVM Capacity and it is an optional field. As it is reported as zero, it is not supported.</span><br><span class="line">unvmcap   : 0                      </span><br><span class="line">rpmbs     : 0</span><br><span class="line"> [31:24]: 0	Access Size</span><br><span class="line"> [23:16]: 0	Total Size</span><br><span class="line">  [5:3] : 0	Authentication Method</span><br><span class="line">  [2:0] : 0	Number of RPMB Units</span><br><span class="line"></span><br><span class="line">edstt     : 0</span><br><span class="line">dsto      : 0</span><br><span class="line">fwug      : 0</span><br><span class="line">kas       : 0</span><br><span class="line">hctma     : 0</span><br><span class="line">  [0:0] : 0	Host Controlled Thermal Management Not Supported</span><br><span class="line"></span><br><span class="line">mntmt     : 0</span><br><span class="line">mxtmt     : 0</span><br><span class="line">sanicap   : 0</span><br><span class="line">  [2:2] : 0	Overwrite Sanitize Operation Not Supported</span><br><span class="line">  [1:1] : 0	Block Erase Sanitize Operation Not Supported</span><br><span class="line">  [0:0] : 0	Crypto Erase Sanitize Operation Not Supported</span><br><span class="line"></span><br><span class="line">hmminds   : 0</span><br><span class="line">hmmaxd    : 0</span><br><span class="line">nsetidmax : 0</span><br><span class="line">anatt     : 0</span><br><span class="line">anacap    : 0</span><br><span class="line">  [7:7] : 0	Non-zero group ID Not Supported</span><br><span class="line">  [6:6] : 0	Group ID does not change</span><br><span class="line">  [4:4] : 0	ANA Change state Not Supported</span><br><span class="line">  [3:3] : 0	ANA Persistent Loss state Not Supported</span><br><span class="line">  [2:2] : 0	ANA Inaccessible state Not Supported</span><br><span class="line">  [1:1] : 0	ANA Non-optimized state Not Supported</span><br><span class="line">  [0:0] : 0	ANA Optimized state Not Supported</span><br><span class="line"></span><br><span class="line">anagrpmax : 0</span><br><span class="line">nanagrpid : 0</span><br><span class="line">sqes      : 0x66   # (Maximum and Required) Submission Queue Entry (SQE) Size. </span><br><span class="line">                   # It is expected to be 64 but with proprietary extensions it can be modified. The value is 0x66 here.</span><br><span class="line">  [7:4] : 0x6	Max SQ Entry Size (64)</span><br><span class="line">  [3:0] : 0x6	Min SQ Entry Size (64)</span><br><span class="line"></span><br><span class="line">cqes      : 0x44   # (Maximum and Required) Completion Queue Entry (CQE) Size. Similar to calculation of SQE size, </span><br><span class="line">                   # its value is 0x44 here, so both maximum and required completion queue entry size is 2⁴&#x3D;16 bytes.</span><br><span class="line">  [7:4] : 0x4	Max CQ Entry Size (16)</span><br><span class="line">  [3:0] : 0x4	Min CQ Entry Size (16)</span><br><span class="line"></span><br><span class="line">maxcmd    : 0</span><br><span class="line">nn        : 1      # (Maximum) Number of Namespaces supported by the controller. Although theoretical maximum is high, here it is 1, </span><br><span class="line">                   # so only one namespace is possible.</span><br><span class="line">oncs      : 0x6    # is Optional NVM Command Support</span><br><span class="line">  [7:7] : 0	Virtualization Management Not Supported</span><br><span class="line">  [6:6] : 0	Timestamp Not Supported</span><br><span class="line">  [5:5] : 0	Reservations Not Supported</span><br><span class="line">  [4:4] : 0	Save and Select Not Supported</span><br><span class="line">  [3:3] : 0	Write Zeroes Not Supported</span><br><span class="line">  [2:2] : 0x1	Data Set Management Supported</span><br><span class="line">  [1:1] : 0x1	Write Uncorrectable Supported</span><br><span class="line">  [0:0] : 0	Compare Not Supported</span><br><span class="line"></span><br><span class="line">fuses     : 0   </span><br><span class="line">  [0:0] : 0	Fused Compare and Write Not Supported</span><br><span class="line"></span><br><span class="line">fna       : 0x4</span><br><span class="line">  [2:2] : 0x1	Crypto Erase Supported as part of Secure Erase</span><br><span class="line">  [1:1] : 0	Crypto Erase Applies to Single Namespace(s)</span><br><span class="line">  [0:0] : 0	Format Applies to Single Namespace(s)</span><br><span class="line"></span><br><span class="line">vwc       : 0</span><br><span class="line">  [0:0] : 0	Volatile Write Cache Not Present</span><br><span class="line"></span><br><span class="line">awun      : 0</span><br><span class="line">awupf     : 0</span><br><span class="line">nvscc     : 0</span><br><span class="line">  [0:0] : 0	NVM Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">nwpc      : 0</span><br><span class="line">  [2:2] : 0	Permanent Write Protect Not Supported</span><br><span class="line">  [1:1] : 0	Write Protect Until Power Supply Not Supported</span><br><span class="line">  [0:0] : 0	No Write Protect and Write Protect Namespace Not Supported</span><br><span class="line"></span><br><span class="line">acwu      : 0</span><br><span class="line">sgls      : 0</span><br><span class="line"> [1:0]  : 0	Scatter-Gather Lists Not Supported</span><br><span class="line"></span><br><span class="line">mnan      : 0</span><br><span class="line">subnqn    :</span><br><span class="line">ioccsz    : 0</span><br><span class="line">iorcsz    : 0</span><br><span class="line">icdoff    : 0</span><br><span class="line">ctrattr   : 0</span><br><span class="line">  [0:0] : 0	Dynamic Controller Model</span><br><span class="line"></span><br><span class="line">msdbd     : 0</span><br><span class="line">ps    0 : mp:18.00W operational enlat:0 exlat:0 rrt:0 rrl:0</span><br><span class="line">          rwt:0 rwl:0 idle_power:- active_power:-</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">sending Identify List Namespaces</span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">$ nvme list-ns &#x2F;dev&#x2F;nvme0 &quot;</span><br><span class="line">[   0]:0x1</span><br><span class="line"></span><br><span class="line"># optane</span><br><span class="line">$ nvme list-ns &#x2F;dev&#x2F;nvme0</span><br><span class="line">NVMe Status:INVALID_NS: The namespace or the format of that namespace is invalid(400b) NSID:0</span><br><span class="line"></span><br><span class="line">$ nvme id-ns &#x2F;dev&#x2F;nvme0 --namespace-id&#x3D;0x1</span><br><span class="line">NVME Identify Namespace 1:</span><br><span class="line">nsze    : 0x5754b9a  # Namespace Size (NSZE). Indicates the number of logical blocks, 0x5754b9a &#x3D; 91573146</span><br><span class="line">                     # lsblk -b show nvme0n1     259:0    0  375083606016  0 disk    91573146*4096&#x3D;375083606016</span><br><span class="line">ncap    : 0x5754b9a  # The maximum number of logical blocks allocated to the namespace. </span><br><span class="line">                     # If there is a thin provisioning (if disk space is allocated on demand), </span><br><span class="line">                     # this value can be less than NSZE. Here, it is not the case so its value is same as NSZE.</span><br><span class="line">nuse    : 0x5754b9aa # nuse, Namespace Utilization (NUSE). The current number of logical blocks allocated to the namespace. </span><br><span class="line">                     # If there is a thin provisioning (if disk space is allocated on demand), this value can be less than NSZE. </span><br><span class="line">                     # Here, it is not the case so its value is same as NSZE.</span><br><span class="line">nsfeat  : 0          #  Namespace Features (NSFEAT)</span><br><span class="line">                     # Bit 3 &#x3D; 0, NGUID and EUI64 values may be reused by the controller after this namespace is deleted.</span><br><span class="line">                     # Bit 2 &#x3D; 0, the controller does not support the Deallocated or Unwritten Logical Block error.</span><br><span class="line">                     # Bit 1 &#x3D; 0, AWUN, AWUPF and ACWU fields should be used instead of NAWUN, NAWUPF, NACWU.</span><br><span class="line">                     # Bit 0 &#x3D; 0, meaning the namespace does not support Thin Provisioning.</span><br><span class="line">nlbaf   : 6          # Number of LBA Formats (NLBAF). Indicates the number of supported LBA data size and metadata size </span><br><span class="line">                     # combinations supported by the namespace. </span><br><span class="line">                     # If It is a zero based value and its value here is 0, so there is only 1 format supported.</span><br><span class="line">flbas   : 0x3        # Formatted LBA Size (FLBAS). Indicates the LBA data size and metadata size combination </span><br><span class="line">                     # Bits 3:0 indicates one of the 16 supported LBA Formats indicated in this data structure. </span><br><span class="line"></span><br><span class="line">                     #LBA Format fields:</span><br><span class="line"></span><br><span class="line">                     #ms, Metadata Size (MS). Since its value is 0, metadata is not supported.</span><br><span class="line">                     #ds, LBA Data Size (LBADS). It is reported in terms of a power of two, so LBA data size is 2⁹ &#x3D; 512 bytes.</span><br><span class="line">                     #rp, Releative Performance (RP). Indicates the relative performance of this format to other formats. </span><br><span class="line">                     # Value of 0 indicates it is the best performance. </span><br><span class="line">                     # It does not make much sense here because we have only one LBA Format supported.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mc      : 0x1</span><br><span class="line">dpc     : 0x11</span><br><span class="line">dps     : 0          # End-to-end Data Protection Type Settings (DPS), T10 PI</span><br><span class="line">                     # Bit 3 if set to ‘1’ indicates that the protection information, </span><br><span class="line">                     # if enabled, is transferred as the first eight bytes of metadata. </span><br><span class="line">                     # Bit 3 if cleared to ‘0’ indicates that the protection information, </span><br><span class="line">                     # if enabled, is transferred as the last eight bytes of metadata.</span><br><span class="line">                     # 000b Protection information is not enabled</span><br><span class="line">                     # 001b Protection information is enabled, Type 1</span><br><span class="line">                     # 010b Protection information is enabled, Type 2</span><br><span class="line">                     # 011b Protection information is enabled, Type 3</span><br><span class="line">                     # 100b – 111b Reserved</span><br><span class="line">nmic    : 0</span><br><span class="line">rescap  : 0</span><br><span class="line">fpi     : 0</span><br><span class="line">dlfeat  : 0</span><br><span class="line">nawun   : 0</span><br><span class="line">nawupf  : 0</span><br><span class="line">nacwu   : 0</span><br><span class="line">nabsn   : 0</span><br><span class="line">nabo    : 0</span><br><span class="line">nabspf  : 0</span><br><span class="line">noiob   : 0</span><br><span class="line">nvmcap  : 0</span><br><span class="line">nsattr	: 0</span><br><span class="line">nvmsetid: 0</span><br><span class="line">anagrpid: 0</span><br><span class="line">endgid  : 0</span><br><span class="line">nguid   : 00000000000000000000000000000000</span><br><span class="line">eui64   : 5cd2e4e419330100</span><br><span class="line">lbaf  0 : ms:0   lbads:9  rp:0x2</span><br><span class="line">lbaf  1 : ms:8   lbads:9  rp:0x2</span><br><span class="line">lbaf  2 : ms:16  lbads:9  rp:0x2</span><br><span class="line">lbaf  3 : ms:0   lbads:12 rp:0 (in use)</span><br><span class="line">lbaf  4 : ms:8   lbads:12 rp:0</span><br><span class="line">lbaf  5 : ms:64  lbads:12 rp:0</span><br><span class="line">lbaf  6 : ms:128 lbads:12 rp:0</span><br></pre></td></tr></table></figure>

<p><a href="https://nvmexpress.org/wp-content/uploads/NVM_Express_Revision_1.3.pdf" target="_blank" rel="noopener">nvme_express_revision</a><br>nvme admin command </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">VMe Admin Commands</span><br><span class="line">Here are the NVMe admin commands with opcodes:</span><br><span class="line">Create and Delete I/O Submission Queue (01h, 00h)</span><br><span class="line">Get Log Page (02h)</span><br><span class="line">Create and Delete I/O Completion Queue (05h, 04h)</span><br><span class="line">Identify (06h)</span><br><span class="line">Abort (08h)</span><br><span class="line">Get and Set Features (0Ah, 09h)</span><br><span class="line">Asynchronous Event Request (0Ch)</span><br><span class="line">Namespace Management (0Dh)</span><br><span class="line">Firmware Commit and Image Download (10h, 11h)</span><br><span class="line">Device Self-test (14h)</span><br><span class="line">Namespace Attachment (15h)</span><br><span class="line">Keep Alive (18h)</span><br><span class="line">Directive Send and Receive (19h, 1Ah)</span><br><span class="line">Virtualization Management (1Ch)</span><br><span class="line">NVMe-MI Send and Receive (1Dh, 1Eh)</span><br><span class="line">Doorbell Buffer Config (7Ch)</span><br><span class="line">Format NVM (80h)</span><br><span class="line">Security Send and Receive (81h, 82h)</span><br><span class="line">Sanitize (84h)</span><br><span class="line"></span><br><span class="line">$ nvme admin-passthru /dev/nvme0 --opcode=0x06 --cdw10=0x0001 --data-len=4096 -r -d -s</span><br><span class="line">opcode       : 06</span><br><span class="line">flags        : 00</span><br><span class="line">rsvd1        : 0000</span><br><span class="line">nsid         : 00000000</span><br><span class="line">cdw2         : 00000000</span><br><span class="line">cdw3         : 00000000</span><br><span class="line">data_len     : 00001000</span><br><span class="line">metadata_len : 00000000</span><br><span class="line">addr         : 563223139000</span><br><span class="line">metadata     : 0</span><br><span class="line">cdw10        : 00000001</span><br><span class="line">cdw11        : 00000000</span><br><span class="line">cdw12        : 00000000</span><br><span class="line">cdw13        : 00000000</span><br><span class="line">cdw14        : 00000000</span><br><span class="line">cdw15        : 00000000</span><br><span class="line">timeout_ms   : 00000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># NVM command</span></span><br><span class="line"><span class="comment"># NVM comands should only be sent if controller is ready (indicated by Controller Status register CSTS.RDY) and after I/O submission and completion queue have been created.</span></span><br><span class="line">Flush (00h)</span><br><span class="line">Write and Read (01h, 02h)</span><br><span class="line">Write Uncorrectable (04h)</span><br><span class="line">Compare (05h)</span><br><span class="line">Write Zeroes (08h)</span><br><span class="line">Dataset Management (09h)</span><br><span class="line">Reservation Register and Report (0Dh, 0Eh)</span><br><span class="line">Reservation Acquire and Release (11h, 15h)</span><br><span class="line"></span><br><span class="line">$ nvme show-regs -H /dev/nvme0</span><br><span class="line"><span class="built_in">cap</span>     : 2004010fff</span><br><span class="line">	Memory Page Size Maximum      (MPSMAX): 4096 bytes</span><br><span class="line">	Memory Page Size Minimum      (MPSMIN): 4096 bytes</span><br><span class="line">	Boot Partition Support           (BPS): No</span><br><span class="line">	Command Sets Supported           (CSS): NVM <span class="built_in">command</span> <span class="built_in">set</span> is supported</span><br><span class="line">	NVM Subsystem Reset Supported  (NSSRS): No</span><br><span class="line">	Doorbell Stride                (DSTRD): 4 bytes</span><br><span class="line">	Timeout                           (TO): 2000 ms</span><br><span class="line">	Arbitration Mechanism Supported  (AMS): Weighted Round Robin with Urgent Priority Class is not supported</span><br><span class="line">	Contiguous Queues Required       (CQR): Yes</span><br><span class="line">	Maximum Queue Entries Supported (MQES): 4096  <span class="comment">### Bytes</span></span><br><span class="line"></span><br><span class="line">version : 10000</span><br><span class="line">	NVMe specification 1.0</span><br><span class="line"></span><br><span class="line">cc      : 460001</span><br><span class="line">	I/O Completion Queue Entry Size (IOCQES): 16 bytes</span><br><span class="line">	I/O Submission Queue Entry Size (IOSQES): 64 bytes</span><br><span class="line">	Shutdown Notification              (SHN): No notification; no effect</span><br><span class="line">	Arbitration Mechanism Selected     (AMS): Round Robin</span><br><span class="line">	Memory Page Size                   (MPS): 4096 bytes</span><br><span class="line">	I/O Command Sets Selected          (CSS): NVM Command Set</span><br><span class="line">	Enable                              (EN): Yes</span><br><span class="line"></span><br><span class="line">csts    : 1</span><br><span class="line">	Processing Paused               (PP): No</span><br><span class="line">	NVM Subsystem Reset Occurred (NSSRO): No</span><br><span class="line">	Shutdown Status               (SHST): Normal operation (no shutdown has been requested)</span><br><span class="line">	Controller Fatal Status        (CFS): False</span><br><span class="line">	Ready                          (RDY): Yes</span><br><span class="line"></span><br><span class="line">nssr    : 0</span><br><span class="line">	NVM Subsystem Reset Control (NSSRC): 0</span><br><span class="line"></span><br><span class="line">intms   : 0</span><br><span class="line">	Interrupt Vector Mask Set (IVMS): 0</span><br><span class="line"></span><br><span class="line">intmc   : 0</span><br><span class="line">	Interrupt Vector Mask Clear (IVMC): 0</span><br><span class="line"></span><br><span class="line">aqa     : 1f001f</span><br><span class="line">	Admin Completion Queue Size (ACQS): 32</span><br><span class="line">	Admin Submission Queue Size (ASQS): 32</span><br><span class="line"></span><br><span class="line">asq     : 10255f9000</span><br><span class="line">	Admin Submission Queue Base (ASQB): 10255f9000</span><br><span class="line"></span><br><span class="line">acq     : 10255f8000</span><br><span class="line">	Admin Completion Queue Base (ACQB): 10255f8000</span><br><span class="line"></span><br><span class="line">cmbloc  : 0</span><br><span class="line">	Controller Memory Buffer feature is not supported</span><br><span class="line"></span><br><span class="line">cmbsz   : 0</span><br><span class="line">	Controller Memory Buffer feature is not supported</span><br><span class="line"></span><br><span class="line">bpinfo  : 0</span><br><span class="line">	Boot Partition feature is not supported</span><br><span class="line"></span><br><span class="line">bprsel  : 0</span><br><span class="line">	Boot Partition feature is not supported</span><br><span class="line"></span><br><span class="line">bpmbl   : 0</span><br><span class="line">	Boot Partition feature is not supported</span><br></pre></td></tr></table></figure>

<h3 id="Read-data-from-the-device"><a href="#Read-data-from-the-device" class="headerlink" title="Read data from the device"></a>Read data from the device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/nvme0n1 of=lba.0.dd bs=512 count=1</span><br><span class="line">$ nvme <span class="built_in">read</span> /dev/nvme0n1 --start-block=0 --block-count=0 --data-size=512 --data=lba.0.read</span><br><span class="line">$ nvme io-passthru /dev/nvme0 --opcode=0x02 --namespace-id=0x1 --data-len=512 --<span class="built_in">read</span> --cdw10=0 --cdw11=0 --cdw12=0 -b &gt; lba.0.io</span><br><span class="line">nvme: malloc.c:2392: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)<span class="string">' failed.</span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/16/network_hardware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/16/network_hardware/" class="post-title-link" itemprop="url">network topology</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-03-16 10:32:49 / Modified: 11:14:08" itemprop="dateCreated datePublished" datetime="2020-03-16T10:32:49+08:00">2020-03-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/16/network_hardware/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/16/network_hardware/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>720</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Deep-buffers-matter"><a href="#Deep-buffers-matter" class="headerlink" title="Deep buffers matter"></a>Deep buffers matter</h3><ul>
<li>lossless networks</li>
<li>how to they deal with incast problems ?<ul>
<li>Answer: tell everyone to stop<ul>
<li>In theory, allows small buffers</li>
<li>In practice, this leads to tree saturation</li>
<li>Causes blocking all the way to all sources<br><img src="/img/deep_buffer_matt-1.png" alt=""><table>
<thead>
<tr>
<th>Customer</th>
<th align="center">Real Buffer Utilization</th>
<th align="right">Cool</th>
</tr>
</thead>
<tbody><tr>
<td>HPC</td>
<td align="center">Storage Clustre -medium</td>
<td align="right">33MB</td>
</tr>
<tr>
<td>Animation</td>
<td align="center">Storage filer(NFS)</td>
<td align="right">6.2MB</td>
</tr>
<tr>
<td>Software vendor</td>
<td align="center">Engineering Build servers</td>
<td align="right">14.9MB</td>
</tr>
<tr>
<td>Online shopping</td>
<td align="center">Hadoop 2K servers -big data</td>
<td align="right">52.3MB</td>
</tr>
<tr>
<td>Educational</td>
<td align="center">Virtualization</td>
<td align="right">52.4MB</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Deep-Buffers-Matter"><a href="#Deep-Buffers-Matter" class="headerlink" title="Deep Buffers Matter!"></a>Deep Buffers Matter!</h4><p>cause packets dropped per teragen<br>Improving uplink contention in mixed speed networks<br>High Density in core/spine (many-to-one, in-cast, fan-in)<br><img src="/img/deep_buffer_matt-2.png" alt=""></p>
<h4 id="Buffer-utilisation-per-port"><a href="#Buffer-utilisation-per-port" class="headerlink" title="Buffer utilisation per port"></a>Buffer utilisation per port</h4><p>some switch get the lower buffer utilisation<br>it could cause a lot of tcp retransmit</p>
<p>The question is our issues.<br>How much buffer are you using ? Any visibility ?<br>What cause your retransmits ?<br><img src="/img/deep_buffer_matt-3.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/gdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/03/gdb/" class="post-title-link" itemprop="url">GDB tips</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-03 22:17:33" itemprop="dateCreated datePublished" datetime="2020-03-03T22:17:33+08:00">2020-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-19 12:10:54" itemprop="dateModified" datetime="2020-05-19T12:10:54+08:00">2020-05-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/gdb/" itemprop="url" rel="index">
                    <span itemprop="name">gdb</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/03/gdb/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/03/gdb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="print-argv"><a href="#print-argv" class="headerlink" title="print argv"></a><a href="https://wizardforcel.gitbooks.io/100-gdb-tips/set-program-args.html" target="_blank" rel="noopener">print argv</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -g3 walk1.c -o walk</span><br><span class="line">$ gdb ./walk <span class="comment"># or you could $ gdb -args ./walk /tmp 10</span></span><br><span class="line">Reading symbols from /root/walk...done.</span><br><span class="line"></span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x400bb8: file walk1.c, line 73.</span><br><span class="line">(gdb) r /tmp 10 <span class="comment">#  or you could (gdb) set args /tmp 10</span></span><br><span class="line">Starting program: /root/./walk /tmp 10</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=3, argv=0x7fffffffe138) at walk1.c:73</span><br><span class="line">73	    <span class="keyword">if</span>(argc != 3)</span><br><span class="line">(gdb) p argc</span><br><span class="line"><span class="variable">$1</span> = 3</span><br><span class="line">(gdb) p argv</span><br><span class="line"><span class="variable">$2</span> = (char **) 0x7fffffffe138</span><br><span class="line">(gdb) p argv[0]</span><br><span class="line"><span class="variable">$3</span> = 0x7fffffffe414 <span class="string">"/root/./walk"</span></span><br><span class="line">(gdb) p argv[1]</span><br><span class="line"><span class="variable">$4</span> = 0x7fffffffe421 <span class="string">"/tmp"</span></span><br><span class="line">(gdb) p argv[2]</span><br><span class="line"><span class="variable">$5</span> = 0x7fffffffe426 <span class="string">"10"</span></span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach args</span></span><br><span class="line">$ gdb --args /bin/bash -c <span class="string">'ls -l'</span></span><br><span class="line">$ <span class="built_in">set</span> listsize 50</span><br><span class="line">$ p *args@4 </span><br><span class="line"></span><br><span class="line"><span class="comment"># if the software was install by source, you could add --directory for import debug symbol</span></span><br><span class="line"><span class="comment"># re-complie bash</span></span><br><span class="line"></span><br><span class="line">$ gdb --args /usr/<span class="built_in">local</span>/bin/bash -c <span class="string">'echo [1g]'</span> --directory ~/tools/bash-4.4</span><br><span class="line">(gdb) la src</span><br><span class="line"></span><br><span class="line"><span class="comment">## if you want disable optimze</span></span><br><span class="line">$ CFLAGS=<span class="string">"-g -O0"</span> CXXFLAGS=<span class="string">"-g -O0"</span> LDFLAGS=<span class="string">"-g"</span>  ./configure --<span class="built_in">enable</span>-debugger</span><br><span class="line">$ CFLAGS=<span class="string">"-g -O0"</span> CXXFLAGS=<span class="string">"-g -O0"</span> LDFLAGS=<span class="string">"-g"</span>  ./make -j 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## set debug directory</span></span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory &lt;directory&gt;</span><br><span class="line">(gdb) show debug-file-directory</span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory /usr/lib/debug</span><br><span class="line">add-symbol-file filename address</span><br><span class="line">add-symbol-file filename address [ -readnow ] [ -mapped ]</span><br><span class="line">add-symbol-file filename -ssection address ...</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/04/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/04/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-04 13:00:28" itemprop="dateCreated datePublished" datetime="2020-01-04T13:00:28+08:00">2020-01-04</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/01/04/hello-world/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/04/hello-world/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>357</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/01/04/hello-world/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/29/lfs_command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/29/lfs_command/" class="post-title-link" itemprop="url">lfs command</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-29 15:41:16" itemprop="dateCreated datePublished" datetime="2019-12-29T15:41:16+08:00">2019-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-03 23:58:52" itemprop="dateModified" datetime="2020-06-03T23:58:52+08:00">2020-06-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filesystem/" itemprop="url" rel="index">
                    <span itemprop="name">filesystem</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/12/29/lfs_command/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/29/lfs_command/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>33 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="format"><a href="#format" class="headerlink" title="format"></a>format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mdt</span></span><br><span class="line">FSNAME=lustre</span><br><span class="line">MDS1NID=0.0.0.0@tcp</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> mkfs.lustre --reformat --mgs --backfstype=zfs --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> mdt_0/mgt_0</span><br><span class="line"><span class="built_in">echo</span> mkfs.lustre --reformat --mdt --backfstype=zfs --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span> --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> --index=0 mdt_0/mdt_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ost</span></span><br><span class="line">FSNAME=lustre</span><br><span class="line">MDS1NID=1.1.1.1@tcp</span><br><span class="line">MDS2NID=2.2.2.2@tcp</span><br><span class="line">OSS1NID=3.3.3.3@tcp </span><br><span class="line">OSS2NID=4.4.4.4@tcp </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..6&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> mkfs.lustre --reformat --backfstype=zfs --ost  --index=<span class="variable">$i</span>  --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;OSS1NID&#125;</span> --servicenode=<span class="variable">$&#123;OSS2NID&#125;</span> --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span>  ost_<span class="variable">$i</span>/ost_<span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="Enable-large-dir-feature"><a href="#Enable-large-dir-feature" class="headerlink" title="Enable large_dir feature"></a>Enable large_dir feature</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tune2fs -O large_dir /dev/nvme0n1p1</span><br><span class="line">$ dumpe2fs -h /dev/nvme0n1p1 | grep feat</span><br><span class="line">$ dumpe2fs 1.45.2.wc1 (27-May-2019)</span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery mmp flex_bg ea_inode dirdata large_dir sparse_super large_file huge_file uninit_bg dir_nlink quota</span><br><span class="line">Journal features:         journal_incompat_revoke</span><br></pre></td></tr></table></figure>

<h3 id="set-stripe-size-for-tiny-files"><a href="#set-stripe-size-for-tiny-files" class="headerlink" title="set stripe size for tiny files"></a>set stripe size for tiny files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe -S 65536 /tfs10</span><br></pre></td></tr></table></figure>

<h3 id="change-ipaddr"><a href="#change-ipaddr" class="headerlink" title="change ipaddr"></a>change ipaddr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tunefs.lustre --erase-params --mgsnode=<span class="variable">$new_mgs_ip</span>@tcp --servicenode=<span class="variable">$new_service_ip</span>@tcp0 --writeconf /dev/md4</span><br></pre></td></tr></table></figure>

<h3 id="Public"><a href="#Public" class="headerlink" title="Public"></a>Public</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">options lnet networks=tcp(bond0)</span><br><span class="line">options ptlrpc ldlm_num_threads=16</span><br><span class="line">options ptlrpc at_max=300</span><br><span class="line">options ptlrpc at_min=50</span><br><span class="line">options ptlrpc ldlm_enqueue_min=250</span><br><span class="line"></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*net_latency, net_latency + quiescent_time) +\\ 2*service_time</span></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*50, 50 + 140) + 2*50 = 50+140 + 100 = 290</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#at_max The largest potential RPC timeout that a client can set is 2*at_max. By lowering at_max from 600 to 400 seconds we reduce the worst case I/O delay from 1200 seconds, or 20 minutes, to 800 seconds or just over 13 minutes.</span></span><br><span class="line"><span class="comment">#at_min The 40 second value factors into our calculation for an appropriate LDLM timeout as discussed in section LDLM Timeouts. Our recommendation for Lustre servers is also 40 seconds</span></span><br><span class="line"><span class="comment">#Adaptive Timeouts: In a Lustre file system servers keep track of the time it takes for RPCs to be completed</span></span><br><span class="line"><span class="comment">#The quiescent_time in this formula is to account for the time it takes all Lustre clients to reestablish connections with all Lustre targets following an HSN quiesce. We've experimentally determined an average time to be approximately 140 seconds, but it is possible that this value may vary based on different factors such as the number of Lustre clients, the number of Lustre targets, the number of Lustre file systems mounted on each client, etc. Thus, given an at_min of 40 seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">options ptlrpc ldlm_enqueue_min=250</span><br><span class="line"></span><br><span class="line"><span class="comment"># readonly mount</span></span><br><span class="line">$ mount.lfs <span class="variable">$zpool</span> /ost0 -o rdonly_dev</span><br></pre></td></tr></table></figure>
<p><a href="http://wiki.lfs.org/Lustre_Resiliency:_Understanding_Lustre_Message_Loss_and_Tuning_for_Resiliency#Tuning_Lustre_for_Resiliency" target="_blank" rel="noopener">Understanding Lustre Message Loss and Tuning for Resiliency</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/12/29/lfs_command/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/26/xfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/26/xfs/" class="post-title-link" itemprop="url">xfs</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-26 16:12:19" itemprop="dateCreated datePublished" datetime="2019-11-26T16:12:19+08:00">2019-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-21 00:12:54" itemprop="dateModified" datetime="2020-04-21T00:12:54+08:00">2020-04-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filesystem/" itemprop="url" rel="index">
                    <span itemprop="name">filesystem</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/26/xfs/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/26/xfs/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="http://fibrevillage.com/storage" target="_blank" rel="noopener">reference</a></p>
<h4 id="format"><a href="#format" class="headerlink" title="format"></a>format</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Raid 60  24 HDD ，12HDD/per raid6   （12-2）× 2 ， Raid stripe size 64KB</span></span><br><span class="line">$ mkfs.xfs -f -d sunit=64,swidth=$((64*20)) /dev/sdxx1</span><br><span class="line"><span class="comment">#su: Stripe unit, which is the RAID chunk size, in bytes</span></span><br><span class="line"><span class="comment">#sw: Multiplier of the stripe unit, i.e. number of data disks</span></span><br><span class="line"></span><br><span class="line">$ mkfs.xfs /dev/device</span><br><span class="line">$ mkfs. xfs -d su= 64k,sw= 4 /dev/device</span><br></pre></td></tr></table></figure>
<p>su = value<br>    Specifies a stripe unit or RAID chunk size. The value must be specified in bytes, with an optional k, m, or g suffix.<br>sw= value<br>    Specifies the number of data disks in a RAID device, or the number of stripe units in the stripe.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/11/26/xfs/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/26/smartctl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/logo-4-blog.png">
      <meta itemprop="name" content="Ginger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b946c5a0bf547c89">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/26/smartctl/" class="post-title-link" itemprop="url">smartctl</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-26 16:12:19" itemprop="dateCreated datePublished" datetime="2019-11-26T16:12:19+08:00">2019-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-05 12:08:28" itemprop="dateModified" datetime="2020-01-05T12:08:28+08:00">2020-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/scsi/" itemprop="url" rel="index">
                    <span itemprop="name">scsi</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/26/smartctl/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/26/smartctl/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="smart-test"><a href="#smart-test" class="headerlink" title="smart test"></a>smart test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -t long /dev/sdx</span><br><span class="line">$ smartctl -t short /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment">#self test result</span></span><br><span class="line">$ smartctl --capabilities /dev/sdxx</span><br><span class="line">$ smartctl --<span class="built_in">log</span>=selftest /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># During selected tests the specified range of LBAs is checked. The LBAs to be scanned are specified in the following formats:</span></span><br><span class="line">$ smartctl -t select,0-10 -t select,5-15 -t select,10-20 /dev/sdxx</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/11/26/smartctl/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ginger"
      src="/img/logo-4-blog.png">
  <p class="site-author-name" itemprop="name">Ginger</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ginger</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">976k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">14:48</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://b946c5a0bf547c89.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
